---
phase: 01-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - apps/convex/package.json
  - apps/convex/convex/schema.ts
  - apps/convex/convex/jurisdictions.ts
  - apps/convex/convex/sources.ts
  - apps/convex/convex/conversations.ts
  - apps/convex/convex/messages.ts
  - apps/convex/tsconfig.json
autonomous: false
user_setup:
  - service: convex
    why: "Real-time backend and database"
    env_vars:
      - name: CONVEX_DEPLOY_KEY
        source: "Convex Dashboard -> Settings -> Deploy Key (for CI/CD)"
    dashboard_config:
      - task: "Create Convex project"
        location: "https://dashboard.convex.dev -> New Project"

must_haves:
  truths:
    - "npx convex dev starts without errors"
    - "Schema generates TypeScript types in _generated/"
    - "Queries return empty arrays (no data yet)"
    - "Mutations can insert test data"
  artifacts:
    - path: "apps/convex/convex/schema.ts"
      provides: "Database schema with 4 tables"
      contains: "defineSchema"
    - path: "apps/convex/convex/_generated/api.d.ts"
      provides: "Generated API types"
      contains: "export declare const api"
    - path: "apps/convex/convex/jurisdictions.ts"
      provides: "Jurisdiction queries and mutations"
      exports: ["list", "add"]
  key_links:
    - from: "apps/convex/convex/jurisdictions.ts"
      to: "apps/convex/convex/schema.ts"
      via: "table reference"
      pattern: "ctx\\.db\\.query\\(\"jurisdictions\"\\)"
---

<objective>
Initialize Convex backend with schema defining jurisdictions, sources, conversations, and messages tables.

Purpose: Create the real-time backend that powers the compliance research application.
Output: Working Convex project with schema, generated types, and basic CRUD operations.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Convex project with schema</name>
  <files>
    apps/convex/package.json
    apps/convex/convex/schema.ts
    apps/convex/tsconfig.json
  </files>
  <action>
1. Create `apps/convex/` directory and initialize:
   - package.json with:
     ```json
     {
       "name": "@compliance-iq/convex",
       "version": "0.1.0",
       "private": true,
       "scripts": {
         "dev": "convex dev",
         "deploy": "convex deploy"
       },
       "dependencies": {
         "convex": "^1.17.0",
         "@compliance-iq/shared-types": "workspace:*"
       }
     }
     ```
   - tsconfig.json extending @compliance-iq/tsconfig/node.json

2. Run `pnpm install` from root to link dependencies

3. Run `npx convex init` in apps/convex/ to initialize Convex project
   - This creates convex/ directory with _generated/ folder

4. Create `apps/convex/convex/schema.ts` with tables:
   ```typescript
   import { defineSchema, defineTable } from "convex/server";
   import { v } from "convex/values";

   export default defineSchema({
     jurisdictions: defineTable({
       name: v.string(),
       type: v.union(
         v.literal("federal"),
         v.literal("state"),
         v.literal("county"),
         v.literal("municipal")
       ),
       stateCode: v.optional(v.string()),
       countyFips: v.optional(v.string()),
       cityName: v.optional(v.string()),
       isActive: v.boolean(),
       createdAt: v.number(),
       updatedAt: v.number(),
     }).index("by_type", ["type"])
       .index("by_state", ["stateCode"]),

     sources: defineTable({
       jurisdictionId: v.id("jurisdictions"),
       name: v.string(),
       url: v.string(),
       sourceType: v.union(
         v.literal("api"),
         v.literal("scrape"),
         v.literal("manual")
       ),
       lastScrapedAt: v.optional(v.number()),
       lastSuccessAt: v.optional(v.number()),
       status: v.union(
         v.literal("active"),
         v.literal("error"),
         v.literal("pending")
       ),
       errorMessage: v.optional(v.string()),
       createdAt: v.number(),
       updatedAt: v.number(),
     }).index("by_jurisdiction", ["jurisdictionId"])
       .index("by_status", ["status"]),

     conversations: defineTable({
       userId: v.string(),
       title: v.optional(v.string()),
       createdAt: v.number(),
       updatedAt: v.number(),
     }).index("by_user", ["userId"]),

     messages: defineTable({
       conversationId: v.id("conversations"),
       role: v.union(v.literal("user"), v.literal("assistant")),
       content: v.string(),
       status: v.union(
         v.literal("pending"),
         v.literal("processing"),
         v.literal("streaming"),
         v.literal("complete"),
         v.literal("error")
       ),
       citations: v.optional(v.array(v.object({
         text: v.string(),
         sourceUrl: v.string(),
         jurisdiction: v.string(),
       }))),
       createdAt: v.number(),
       updatedAt: v.number(),
     }).index("by_conversation", ["conversationId"]),
   });
   ```

5. Run `npx convex dev` to generate types (this will prompt for project creation if not done)
  </action>
  <verify>
    - `ls apps/convex/convex/_generated/` shows api.d.ts and dataModel.d.ts
    - `cat apps/convex/convex/schema.ts | grep "defineSchema"` confirms schema exists
    - `npx convex dev` in apps/convex/ starts without errors (Ctrl+C to exit)
  </verify>
  <done>Convex project initialized with schema defining jurisdictions, sources, conversations, and messages tables</done>
</task>

<task type="auto">
  <name>Task 2: Create queries and mutations for core tables</name>
  <files>
    apps/convex/convex/jurisdictions.ts
    apps/convex/convex/sources.ts
    apps/convex/convex/conversations.ts
    apps/convex/convex/messages.ts
  </files>
  <action>
1. Create `apps/convex/convex/jurisdictions.ts`:
   ```typescript
   import { query, mutation } from "./_generated/server";
   import { v } from "convex/values";

   export const list = query({
     args: { type: v.optional(v.string()) },
     handler: async (ctx, args) => {
       if (args.type) {
         return await ctx.db
           .query("jurisdictions")
           .withIndex("by_type", (q) => q.eq("type", args.type as any))
           .collect();
       }
       return await ctx.db.query("jurisdictions").collect();
     },
   });

   export const add = mutation({
     args: {
       name: v.string(),
       type: v.union(
         v.literal("federal"),
         v.literal("state"),
         v.literal("county"),
         v.literal("municipal")
       ),
       stateCode: v.optional(v.string()),
       countyFips: v.optional(v.string()),
       cityName: v.optional(v.string()),
     },
     handler: async (ctx, args) => {
       const now = Date.now();
       return await ctx.db.insert("jurisdictions", {
         ...args,
         isActive: true,
         createdAt: now,
         updatedAt: now,
       });
     },
   });
   ```

2. Create `apps/convex/convex/sources.ts`:
   ```typescript
   import { query, mutation } from "./_generated/server";
   import { v } from "convex/values";

   export const list = query({
     args: { jurisdictionId: v.optional(v.id("jurisdictions")) },
     handler: async (ctx, args) => {
       if (args.jurisdictionId) {
         return await ctx.db
           .query("sources")
           .withIndex("by_jurisdiction", (q) => q.eq("jurisdictionId", args.jurisdictionId!))
           .collect();
       }
       return await ctx.db.query("sources").collect();
     },
   });

   export const add = mutation({
     args: {
       jurisdictionId: v.id("jurisdictions"),
       name: v.string(),
       url: v.string(),
       sourceType: v.union(
         v.literal("api"),
         v.literal("scrape"),
         v.literal("manual")
       ),
     },
     handler: async (ctx, args) => {
       const now = Date.now();
       return await ctx.db.insert("sources", {
         ...args,
         status: "pending",
         createdAt: now,
         updatedAt: now,
       });
     },
   });

   export const updateStatus = mutation({
     args: {
       id: v.id("sources"),
       status: v.union(
         v.literal("active"),
         v.literal("error"),
         v.literal("pending")
       ),
       errorMessage: v.optional(v.string()),
     },
     handler: async (ctx, args) => {
       const now = Date.now();
       await ctx.db.patch(args.id, {
         status: args.status,
         errorMessage: args.errorMessage,
         lastScrapedAt: now,
         lastSuccessAt: args.status === "active" ? now : undefined,
         updatedAt: now,
       });
     },
   });
   ```

3. Create `apps/convex/convex/conversations.ts`:
   ```typescript
   import { query, mutation } from "./_generated/server";
   import { v } from "convex/values";

   export const list = query({
     args: { userId: v.string() },
     handler: async (ctx, args) => {
       return await ctx.db
         .query("conversations")
         .withIndex("by_user", (q) => q.eq("userId", args.userId))
         .order("desc")
         .collect();
     },
   });

   export const create = mutation({
     args: { userId: v.string(), title: v.optional(v.string()) },
     handler: async (ctx, args) => {
       const now = Date.now();
       return await ctx.db.insert("conversations", {
         userId: args.userId,
         title: args.title,
         createdAt: now,
         updatedAt: now,
       });
     },
   });
   ```

4. Create `apps/convex/convex/messages.ts`:
   ```typescript
   import { query, mutation } from "./_generated/server";
   import { v } from "convex/values";

   export const byConversation = query({
     args: { conversationId: v.id("conversations") },
     handler: async (ctx, args) => {
       return await ctx.db
         .query("messages")
         .withIndex("by_conversation", (q) => q.eq("conversationId", args.conversationId))
         .order("asc")
         .collect();
     },
   });

   export const send = mutation({
     args: {
       conversationId: v.id("conversations"),
       content: v.string(),
       role: v.union(v.literal("user"), v.literal("assistant")),
     },
     handler: async (ctx, args) => {
       const now = Date.now();
       return await ctx.db.insert("messages", {
         conversationId: args.conversationId,
         role: args.role,
         content: args.content,
         status: "complete",
         createdAt: now,
         updatedAt: now,
       });
     },
   });

   export const updateStatus = mutation({
     args: {
       id: v.id("messages"),
       status: v.union(
         v.literal("pending"),
         v.literal("processing"),
         v.literal("streaming"),
         v.literal("complete"),
         v.literal("error")
       ),
       content: v.optional(v.string()),
     },
     handler: async (ctx, args) => {
       const now = Date.now();
       const patch: Record<string, unknown> = {
         status: args.status,
         updatedAt: now,
       };
       if (args.content !== undefined) {
         patch.content = args.content;
       }
       await ctx.db.patch(args.id, patch);
     },
   });
   ```

5. Run `npx convex dev` to verify all functions compile and generate
  </action>
  <verify>
    - `npx convex dev` in apps/convex/ starts without TypeScript errors
    - `cat apps/convex/convex/_generated/api.d.ts | grep "jurisdictions"` shows generated types
    - Functions are accessible via generated api object
  </verify>
  <done>CRUD operations created for all 4 tables with proper typing and indexes</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Convex backend with schema and CRUD operations for jurisdictions, sources, conversations, and messages</what-built>
  <how-to-verify>
1. In apps/convex/, run `npx convex dev`
2. Visit the Convex dashboard URL shown in terminal
3. Navigate to "Functions" tab - verify all 4 modules visible (jurisdictions, sources, conversations, messages)
4. Navigate to "Data" tab - verify all 4 tables exist (empty)
5. In Dashboard, try running a test mutation:
   - Go to Functions -> jurisdictions -> add
   - Run with args: { "name": "Federal", "type": "federal" }
   - Verify record appears in Data tab under jurisdictions
  </how-to-verify>
  <resume-signal>Type "approved" if Convex dashboard shows tables and test mutation works, or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `npx convex dev` starts without errors
2. Schema defines all 4 tables: jurisdictions, sources, conversations, messages
3. Generated types exist in `_generated/` directory
4. All queries and mutations compile and are accessible
5. Test data can be inserted via Convex dashboard
</verification>

<success_criteria>
- Convex project initialized and connected to Convex cloud
- Schema with 4 tables matches ROADMAP success criteria
- Generated TypeScript types available for frontend consumption
- CRUD operations work via Convex dashboard
- Tables have proper indexes for query performance
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
