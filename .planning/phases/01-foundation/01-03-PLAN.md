---
phase: 01-foundation
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - apps/workers/package.json
  - apps/workers/wrangler.jsonc
  - apps/workers/src/index.ts
  - apps/workers/src/types.ts
  - apps/workers/tsconfig.json
autonomous: false
user_setup:
  - service: cloudflare
    why: "Serverless compute and R2 storage for data pipeline"
    env_vars:
      - name: CLOUDFLARE_API_TOKEN
        source: "Cloudflare Dashboard -> My Profile -> API Tokens -> Create Token"
    dashboard_config:
      - task: "Create R2 bucket named 'compliance-documents'"
        location: "Cloudflare Dashboard -> R2 -> Create bucket"

must_haves:
  truths:
    - "wrangler dev starts local server without errors"
    - "Worker responds to health check request"
    - "R2 bucket binding is configured in wrangler.jsonc"
    - "TypeScript types are generated from wrangler config"
  artifacts:
    - path: "apps/workers/wrangler.jsonc"
      provides: "Cloudflare Workers configuration with R2 binding"
      contains: "r2_buckets"
    - path: "apps/workers/src/index.ts"
      provides: "Worker entry point"
      contains: "export default"
    - path: "apps/workers/worker-configuration.d.ts"
      provides: "Generated Cloudflare types"
      contains: "interface Env"
  key_links:
    - from: "apps/workers/src/index.ts"
      to: "apps/workers/wrangler.jsonc"
      via: "env bindings"
      pattern: "env\\.DOCUMENTS_BUCKET"
---

<objective>
Initialize Cloudflare Workers project with R2 bucket binding for document storage.

Purpose: Create the serverless compute layer for batch data processing (scraping, embedding, indexing).
Output: Working Cloudflare Worker with R2 binding, ready for data pipeline workers.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Cloudflare Workers project with wrangler</name>
  <files>
    apps/workers/package.json
    apps/workers/wrangler.jsonc
    apps/workers/tsconfig.json
    apps/workers/src/index.ts
    apps/workers/src/types.ts
  </files>
  <action>
1. Create `apps/workers/` directory structure:
   ```
   apps/workers/
   ├── src/
   │   ├── index.ts
   │   └── types.ts
   ├── package.json
   ├── wrangler.jsonc
   └── tsconfig.json
   ```

2. Create `apps/workers/package.json`:
   ```json
   {
     "name": "@compliance-iq/workers",
     "version": "0.1.0",
     "private": true,
     "scripts": {
       "dev": "wrangler dev",
       "deploy": "wrangler deploy",
       "types": "wrangler types",
       "build": "wrangler deploy --dry-run --outdir=dist"
     },
     "devDependencies": {
       "wrangler": "^3.100.0",
       "@cloudflare/workers-types": "^4.20250121.0",
       "typescript": "^5.0.3"
     },
     "dependencies": {
       "@compliance-iq/shared-types": "workspace:*"
     }
   }
   ```

3. Create `apps/workers/wrangler.jsonc`:
   ```jsonc
   {
     "$schema": "node_modules/wrangler/config-schema.json",
     "name": "compliance-iq-worker",
     "main": "src/index.ts",
     "compatibility_date": "2026-01-31",
     "compatibility_flags": ["nodejs_compat"],

     // R2 bucket for storing scraped documents
     "r2_buckets": [
       {
         "binding": "DOCUMENTS_BUCKET",
         "bucket_name": "compliance-documents"
       }
     ],

     // Environment variables (secrets set via wrangler secret)
     "vars": {
       "ENVIRONMENT": "development"
     }
   }
   ```

4. Create `apps/workers/tsconfig.json`:
   ```json
   {
     "extends": "@compliance-iq/tsconfig/node.json",
     "compilerOptions": {
       "types": ["@cloudflare/workers-types"],
       "lib": ["ES2022"],
       "target": "ES2022",
       "module": "ESNext",
       "moduleResolution": "bundler",
       "noEmit": true
     },
     "include": ["src/**/*.ts", "worker-configuration.d.ts"]
   }
   ```

5. Create `apps/workers/src/types.ts`:
   ```typescript
   // Re-export Env type from generated configuration
   // After running `wrangler types`, this file can import from worker-configuration.d.ts

   export interface Env {
     DOCUMENTS_BUCKET: R2Bucket;
     ENVIRONMENT: string;
   }
   ```

6. Create `apps/workers/src/index.ts`:
   ```typescript
   import type { Env } from './types';

   export default {
     async fetch(request: Request, env: Env, ctx: ExecutionContext): Promise<Response> {
       const url = new URL(request.url);

       // Health check endpoint
       if (url.pathname === '/health') {
         return new Response(JSON.stringify({
           status: 'healthy',
           environment: env.ENVIRONMENT,
           timestamp: new Date().toISOString(),
         }), {
           headers: { 'Content-Type': 'application/json' },
         });
       }

       // R2 test endpoint (list objects)
       if (url.pathname === '/r2/list') {
         try {
           const objects = await env.DOCUMENTS_BUCKET.list({ limit: 10 });
           return new Response(JSON.stringify({
             objects: objects.objects.map(obj => ({
               key: obj.key,
               size: obj.size,
               uploaded: obj.uploaded,
             })),
             truncated: objects.truncated,
           }), {
             headers: { 'Content-Type': 'application/json' },
           });
         } catch (error) {
           return new Response(JSON.stringify({
             error: 'R2 bucket not configured or inaccessible',
             details: error instanceof Error ? error.message : 'Unknown error',
           }), {
             status: 500,
             headers: { 'Content-Type': 'application/json' },
           });
         }
       }

       // Default 404
       return new Response('Not Found', { status: 404 });
     },
   };
   ```

7. Run `pnpm install` from root to install wrangler
8. Run `pnpm --filter @compliance-iq/workers types` to generate worker-configuration.d.ts
  </action>
  <verify>
    - `ls apps/workers/src/` shows index.ts and types.ts
    - `cat apps/workers/wrangler.jsonc | grep "DOCUMENTS_BUCKET"` shows R2 binding
    - `pnpm --filter @compliance-iq/workers types` generates worker-configuration.d.ts
  </verify>
  <done>Cloudflare Workers project initialized with R2 binding configuration</done>
</task>

<task type="auto">
  <name>Task 2: Verify worker starts and health check responds</name>
  <files>
    (no new files - verification task)
  </files>
  <action>
1. From root, run `pnpm --filter @compliance-iq/workers dev`
   - This starts wrangler dev server
   - Note: R2 will not work in local dev without `--remote` flag

2. Test health check endpoint:
   ```bash
   curl http://localhost:8787/health
   ```
   - Should return JSON with status: "healthy"

3. Test 404 handler:
   ```bash
   curl http://localhost:8787/unknown
   ```
   - Should return "Not Found" with 404 status

4. Note for user: R2 bucket must be created in Cloudflare dashboard before deploying
   - Bucket name: "compliance-documents"
   - After creating bucket, run `wrangler deploy` to deploy worker
  </action>
  <verify>
    - `curl http://localhost:8787/health` returns JSON with "status": "healthy"
    - Worker process starts without TypeScript errors
    - `curl http://localhost:8787/unknown` returns 404
  </verify>
  <done>Worker runs locally and responds to health check</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Cloudflare Workers project with R2 binding for document storage</what-built>
  <how-to-verify>
1. From project root, run: `pnpm --filter @compliance-iq/workers dev`
2. In another terminal, run: `curl http://localhost:8787/health`
3. Verify response is JSON with "status": "healthy"
4. (Optional) If R2 bucket is created:
   - Stop local dev
   - Run: `pnpm --filter @compliance-iq/workers deploy`
   - Test deployed URL: `curl https://compliance-iq-worker.<your-subdomain>.workers.dev/health`
  </how-to-verify>
  <resume-signal>Type "approved" if health check works locally, or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `wrangler dev` starts without errors
2. Health check endpoint returns healthy status
3. R2 bucket binding is configured in wrangler.jsonc
4. TypeScript types are generated via `wrangler types`
5. Worker structure ready for additional data pipeline workers
</verification>

<success_criteria>
- Cloudflare Workers project initialized in apps/workers/
- wrangler.jsonc configures R2 bucket binding (DOCUMENTS_BUCKET)
- Worker responds to /health endpoint with JSON status
- TypeScript configuration includes Cloudflare Workers types
- Project ready for future data pipeline workers (ingestion, embedding, sync)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`
</output>
