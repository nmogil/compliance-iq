---
phase: 01-foundation
plan: 05
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - scripts/setup-pinecone.ts
  - apps/workers/src/pinecone.ts
autonomous: false
user_setup:
  - service: pinecone
    why: "Vector database for regulatory text embeddings"
    env_vars:
      - name: PINECONE_API_KEY
        source: "Pinecone Console -> API Keys -> Create API Key"
    dashboard_config:
      - task: "Create Pinecone account (free tier available)"
        location: "https://www.pinecone.io/"

must_haves:
  truths:
    - "Pinecone index 'compliance-embeddings' exists in Pinecone console"
    - "Index has 3072 dimensions (matches text-embedding-3-large)"
    - "Index uses cosine metric"
    - "Index is serverless on aws/us-east-1"
  artifacts:
    - path: "scripts/setup-pinecone.ts"
      provides: "Index creation script"
      contains: "createIndex"
    - path: "apps/workers/src/pinecone.ts"
      provides: "Pinecone client utility"
      contains: "Pinecone"
  key_links:
    - from: "scripts/setup-pinecone.ts"
      to: "Pinecone API"
      via: "Pinecone SDK"
      pattern: "pc\\.createIndex"
---

<objective>
Create Pinecone serverless index for storing regulatory text embeddings.

Purpose: Enable vector similarity search for the RAG pipeline in Phase 7.
Output: Pinecone index with 3072 dimensions (text-embedding-3-large) and cosine metric.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Pinecone setup script</name>
  <files>
    scripts/setup-pinecone.ts
    package.json (update scripts)
  </files>
  <action>
1. Create `scripts/` directory at root if not exists

2. Create `scripts/setup-pinecone.ts`:
   ```typescript
   import { Pinecone } from '@pinecone-database/pinecone';

   const INDEX_NAME = 'compliance-embeddings';
   const DIMENSION = 3072; // OpenAI text-embedding-3-large
   const METRIC = 'cosine';

   async function main() {
     const apiKey = process.env.PINECONE_API_KEY;

     if (!apiKey) {
       console.error('Error: PINECONE_API_KEY environment variable is required');
       console.error('Set it with: export PINECONE_API_KEY=your-api-key');
       process.exit(1);
     }

     const pc = new Pinecone({ apiKey });

     console.log('Checking existing indexes...');
     const existingIndexes = await pc.listIndexes();

     const indexExists = existingIndexes.indexes?.some(
       (idx) => idx.name === INDEX_NAME
     );

     if (indexExists) {
       console.log(`Index "${INDEX_NAME}" already exists.`);

       // Describe existing index
       const description = await pc.describeIndex(INDEX_NAME);
       console.log('Index details:');
       console.log(`  - Dimension: ${description.dimension}`);
       console.log(`  - Metric: ${description.metric}`);
       console.log(`  - Host: ${description.host}`);
       console.log(`  - Status: ${description.status?.ready ? 'Ready' : 'Not ready'}`);

       if (description.dimension !== DIMENSION) {
         console.warn(`Warning: Index dimension (${description.dimension}) does not match expected (${DIMENSION})`);
         console.warn('You may need to delete and recreate the index.');
       }

       return;
     }

     console.log(`Creating index "${INDEX_NAME}"...`);
     console.log(`  - Dimension: ${DIMENSION} (for OpenAI text-embedding-3-large)`);
     console.log(`  - Metric: ${METRIC}`);
     console.log(`  - Spec: Serverless (AWS us-east-1)`);

     await pc.createIndex({
       name: INDEX_NAME,
       dimension: DIMENSION,
       metric: METRIC,
       spec: {
         serverless: {
           cloud: 'aws',
           region: 'us-east-1',
         },
       },
       waitUntilReady: true,
     });

     console.log('Index created successfully!');

     // Verify
     const description = await pc.describeIndex(INDEX_NAME);
     console.log('Index details:');
     console.log(`  - Host: ${description.host}`);
     console.log(`  - Status: ${description.status?.ready ? 'Ready' : 'Not ready'}`);
   }

   main().catch((error) => {
     console.error('Error:', error);
     process.exit(1);
   });
   ```

3. Add @pinecone-database/pinecone to root devDependencies

4. Update root `package.json` scripts:
   ```json
   {
     "scripts": {
       "setup:pinecone": "npx tsx scripts/setup-pinecone.ts"
     }
   }
   ```

5. Add tsx to root devDependencies for running TypeScript scripts

6. Run `pnpm install` to install dependencies
  </action>
  <verify>
    - `cat scripts/setup-pinecone.ts | grep "compliance-embeddings"` shows index name
    - `cat scripts/setup-pinecone.ts | grep "3072"` shows correct dimension
    - `pnpm install` completes successfully
  </verify>
  <done>Pinecone setup script created with correct configuration for text-embedding-3-large</done>
</task>

<task type="auto">
  <name>Task 2: Create Pinecone client utility for workers</name>
  <files>
    apps/workers/src/pinecone.ts
    apps/workers/package.json
  </files>
  <action>
1. Add @pinecone-database/pinecone to apps/workers/package.json dependencies

2. Create `apps/workers/src/pinecone.ts`:
   ```typescript
   import { Pinecone, Index, RecordMetadata } from '@pinecone-database/pinecone';

   const INDEX_NAME = 'compliance-embeddings';

   // Metadata schema for regulatory chunks
   export interface ChunkMetadata extends RecordMetadata {
     // Jurisdiction info
     jurisdictionType: 'federal' | 'state' | 'county' | 'municipal';
     jurisdictionId: string;
     stateCode?: string;
     countyFips?: string;
     cityName?: string;

     // Source info
     sourceId: string;
     sourceType: 'ecfr' | 'statutes' | 'admin_code' | 'ordinance';
     sourceUrl: string;

     // Citation info
     citation: string;
     title?: string;
     section?: string;

     // Content info
     chunkIndex: number;
     totalChunks: number;

     // Timestamps
     indexedAt: number;
     sourceLastUpdated?: number;
   }

   let pineconeClient: Pinecone | null = null;
   let pineconeIndex: Index<ChunkMetadata> | null = null;

   export function initPinecone(apiKey: string): Pinecone {
     if (!pineconeClient) {
       pineconeClient = new Pinecone({ apiKey });
     }
     return pineconeClient;
   }

   export function getIndex(apiKey: string): Index<ChunkMetadata> {
     if (!pineconeIndex) {
       const client = initPinecone(apiKey);
       pineconeIndex = client.index<ChunkMetadata>(INDEX_NAME);
     }
     return pineconeIndex;
   }

   export async function upsertChunks(
     apiKey: string,
     chunks: Array<{
       id: string;
       values: number[];
       metadata: ChunkMetadata;
     }>
   ): Promise<void> {
     const index = getIndex(apiKey);
     // Pinecone recommends batches of 100
     const batchSize = 100;
     for (let i = 0; i < chunks.length; i += batchSize) {
       const batch = chunks.slice(i, i + batchSize);
       await index.upsert(batch);
     }
   }

   export async function queryChunks(
     apiKey: string,
     vector: number[],
     options: {
       topK?: number;
       filter?: Partial<ChunkMetadata>;
     } = {}
   ): Promise<Array<{
     id: string;
     score: number;
     metadata: ChunkMetadata;
   }>> {
     const index = getIndex(apiKey);
     const result = await index.query({
       vector,
       topK: options.topK ?? 20,
       filter: options.filter as Record<string, unknown>,
       includeMetadata: true,
     });

     return result.matches.map((match) => ({
       id: match.id,
       score: match.score ?? 0,
       metadata: match.metadata as ChunkMetadata,
     }));
   }
   ```

3. Run `pnpm install` from root
  </action>
  <verify>
    - `cat apps/workers/src/pinecone.ts | grep "ChunkMetadata"` shows metadata type
    - `cat apps/workers/package.json | grep "pinecone"` shows dependency
    - TypeScript compiles without errors: `pnpm --filter @compliance-iq/workers build`
  </verify>
  <done>Pinecone client utility created with typed metadata schema for regulatory chunks</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Pinecone index creation script and client utility</what-built>
  <how-to-verify>
1. Get a Pinecone API key from https://www.pinecone.io/ (free tier available)
2. Set the environment variable: `export PINECONE_API_KEY=your-api-key`
3. Run the setup script: `pnpm setup:pinecone`
4. Verify output shows:
   - "Creating index..." or "Index already exists"
   - Dimension: 3072
   - Metric: cosine
   - Status: Ready
5. Log into Pinecone Console and verify:
   - Index "compliance-embeddings" exists
   - Shows 3072 dimensions
   - Shows serverless / aws / us-east-1
  </how-to-verify>
  <resume-signal>Type "approved" if Pinecone index is created with 3072 dimensions, or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. Pinecone index "compliance-embeddings" exists
2. Index has 3072 dimensions (matches text-embedding-3-large)
3. Index uses cosine metric
4. Index is serverless on AWS us-east-1
5. Pinecone client utility is typed with ChunkMetadata schema
</verification>

<success_criteria>
- Pinecone index created with correct configuration (3072 dims, cosine, serverless)
- Setup script can be rerun safely (idempotent)
- Client utility provides typed upsert and query functions
- Metadata schema defined for regulatory chunks (jurisdiction, source, citation)
- Index ready for Phase 2 data ingestion
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-05-SUMMARY.md`
</output>
