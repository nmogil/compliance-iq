---
phase: 01-foundation
plan: 06
type: execute
wave: 3
depends_on: ["01-01", "01-02", "01-03", "01-04"]
files_modified:
  - .github/workflows/ci.yml
  - apps/convex/vitest.config.ts
  - apps/convex/tests/schema.test.ts
  - apps/web/vitest.config.ts
  - apps/web/tests/App.test.tsx
  - apps/workers/vitest.config.ts
  - apps/workers/tests/health.test.ts
autonomous: true

must_haves:
  truths:
    - "pnpm test runs tests for all workspaces"
    - "pnpm lint runs ESLint across codebase"
    - "GitHub Actions CI passes on push"
    - "Tests exist for each app (convex, web, workers)"
  artifacts:
    - path: ".github/workflows/ci.yml"
      provides: "CI pipeline configuration"
      contains: "pnpm"
    - path: "apps/web/vitest.config.ts"
      provides: "Web app test configuration"
      contains: "defineConfig"
    - path: "apps/workers/tests/health.test.ts"
      provides: "Worker health check test"
      contains: "describe"
  key_links:
    - from: ".github/workflows/ci.yml"
      to: "pnpm-workspace.yaml"
      via: "pnpm install"
      pattern: "pnpm install"
    - from: "vitest.workspace.ts"
      to: "apps/*/vitest.config.ts"
      via: "workspace discovery"
      pattern: "apps/\\*"
---

<objective>
Create GitHub Actions CI/CD pipeline with linting and testing.

Purpose: Ensure code quality and catch regressions before merging.
Output: Working CI pipeline that runs tests and linting on push/PR.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create test configurations and basic tests for each app</name>
  <files>
    apps/convex/vitest.config.ts
    apps/convex/tests/schema.test.ts
    apps/web/vitest.config.ts
    apps/web/tests/App.test.tsx
    apps/web/tests/setup.ts
    apps/workers/vitest.config.ts
    apps/workers/tests/health.test.ts
  </files>
  <action>
1. Create `apps/convex/vitest.config.ts`:
   ```typescript
   import { defineConfig } from 'vitest/config';

   export default defineConfig({
     test: {
       globals: true,
       environment: 'node',
     },
   });
   ```

2. Create `apps/convex/tests/schema.test.ts`:
   ```typescript
   import { describe, it, expect } from 'vitest';

   // Basic schema validation tests
   // Note: Full Convex testing requires their test framework

   describe('Schema Types', () => {
     it('should define jurisdiction types correctly', () => {
       const validTypes = ['federal', 'state', 'county', 'municipal'];
       expect(validTypes).toHaveLength(4);
       expect(validTypes).toContain('federal');
     });

     it('should define message roles correctly', () => {
       const validRoles = ['user', 'assistant'];
       expect(validRoles).toHaveLength(2);
     });

     it('should define source types correctly', () => {
       const validTypes = ['api', 'scrape', 'manual'];
       expect(validTypes).toHaveLength(3);
     });

     it('should define message status correctly', () => {
       const validStatuses = ['pending', 'processing', 'streaming', 'complete', 'error'];
       expect(validStatuses).toHaveLength(5);
     });
   });
   ```

3. Add vitest to apps/convex/package.json devDependencies and add test script

4. Create `apps/web/vitest.config.ts`:
   ```typescript
   import { defineConfig } from 'vitest/config';
   import react from '@vitejs/plugin-react';

   export default defineConfig({
     plugins: [react()],
     test: {
       globals: true,
       environment: 'jsdom',
       setupFiles: ['./tests/setup.ts'],
     },
   });
   ```

5. Create `apps/web/tests/setup.ts`:
   ```typescript
   import '@testing-library/jest-dom/vitest';
   ```

6. Create `apps/web/tests/App.test.tsx`:
   ```typescript
   import { describe, it, expect, vi } from 'vitest';
   import { render, screen } from '@testing-library/react';

   // Mock Convex hooks
   vi.mock('convex/react', () => ({
     useQuery: vi.fn(() => undefined), // Loading state
     ConvexProvider: ({ children }: { children: React.ReactNode }) => children,
   }));

   // Import after mocking
   import App from '../src/App';

   describe('App Component', () => {
     it('should render the header', () => {
       render(<App />);
       expect(screen.getByText('ComplianceIQ')).toBeInTheDocument();
     });

     it('should show loading state initially', () => {
       render(<App />);
       expect(screen.getByText('Loading...')).toBeInTheDocument();
     });

     it('should have Texas in subtitle', () => {
       render(<App />);
       expect(screen.getByText(/Texas/)).toBeInTheDocument();
     });
   });
   ```

7. Add testing dependencies to apps/web/package.json:
   - vitest
   - @testing-library/react
   - @testing-library/jest-dom
   - jsdom

8. Create `apps/workers/vitest.config.ts`:
   ```typescript
   import { defineConfig } from 'vitest/config';

   export default defineConfig({
     test: {
       globals: true,
       environment: 'node',
     },
   });
   ```

9. Create `apps/workers/tests/health.test.ts`:
   ```typescript
   import { describe, it, expect } from 'vitest';

   // Note: Full worker testing requires miniflare or wrangler unstable_dev
   // These are unit tests for utility functions

   describe('Health Check Response', () => {
     it('should have correct structure', () => {
       const healthResponse = {
         status: 'healthy',
         environment: 'test',
         timestamp: new Date().toISOString(),
       };

       expect(healthResponse.status).toBe('healthy');
       expect(healthResponse.environment).toBe('test');
       expect(healthResponse.timestamp).toBeDefined();
     });
   });

   describe('R2 List Response', () => {
     it('should handle empty bucket', () => {
       const emptyResponse = {
         objects: [],
         truncated: false,
       };

       expect(emptyResponse.objects).toHaveLength(0);
       expect(emptyResponse.truncated).toBe(false);
     });
   });
   ```

10. Add vitest to apps/workers/package.json devDependencies and add test script

11. Update each app's package.json with test script: "test": "vitest run"

12. Run `pnpm install` to install all test dependencies
  </action>
  <verify>
    - `pnpm --filter @compliance-iq/convex test` passes
    - `pnpm --filter @compliance-iq/web test` passes
    - `pnpm --filter @compliance-iq/workers test` passes
    - `pnpm test` runs tests for all workspaces
  </verify>
  <done>Test configurations and basic tests created for all apps</done>
</task>

<task type="auto">
  <name>Task 2: Create GitHub Actions CI workflow</name>
  <files>
    .github/workflows/ci.yml
    .eslintrc.js (root)
  </files>
  <action>
1. Create `.github/workflows/` directory

2. Create `.github/workflows/ci.yml`:
   ```yaml
   name: CI

   on:
     push:
       branches: [main]
     pull_request:
       branches: [main]

   jobs:
     build-and-test:
       runs-on: ubuntu-latest

       steps:
         - name: Checkout
           uses: actions/checkout@v4

         - name: Setup pnpm
           uses: pnpm/action-setup@v4
           with:
             version: 10

         - name: Setup Node.js
           uses: actions/setup-node@v4
           with:
             node-version: 20
             cache: 'pnpm'

         - name: Install dependencies
           run: pnpm install --frozen-lockfile

         - name: Generate types
           run: |
             # Generate Convex types (uses cached/mock for CI)
             cd apps/convex && npx convex codegen || true
             cd ../..
             # Generate Cloudflare types
             pnpm --filter @compliance-iq/workers types || true

         - name: Build packages
           run: pnpm -r build

         - name: Lint
           run: pnpm lint

         - name: Test
           run: pnpm test

     type-check:
       runs-on: ubuntu-latest

       steps:
         - name: Checkout
           uses: actions/checkout@v4

         - name: Setup pnpm
           uses: pnpm/action-setup@v4
           with:
             version: 10

         - name: Setup Node.js
           uses: actions/setup-node@v4
           with:
             node-version: 20
             cache: 'pnpm'

         - name: Install dependencies
           run: pnpm install --frozen-lockfile

         - name: Generate types
           run: |
             cd apps/convex && npx convex codegen || true
             cd ../..
             pnpm --filter @compliance-iq/workers types || true

         - name: Type check
           run: pnpm -r exec tsc --noEmit
   ```

3. Create root `.eslintrc.js`:
   ```javascript
   module.exports = {
     root: true,
     extends: ['@compliance-iq/eslint-config'],
     parserOptions: {
       project: ['./tsconfig.json', './apps/*/tsconfig.json', './packages/*/tsconfig.json'],
       tsconfigRootDir: __dirname,
     },
     ignorePatterns: [
       'node_modules/',
       'dist/',
       '_generated/',
       '.next/',
       'coverage/',
     ],
   };
   ```

4. Update root package.json with lint script:
   ```json
   {
     "scripts": {
       "lint": "eslint . --ext .ts,.tsx,.js --max-warnings 0"
     }
   }
   ```

5. Ensure each app has a tsconfig.json for ESLint project references

6. Run `pnpm lint` to verify ESLint works locally
  </action>
  <verify>
    - `ls .github/workflows/ci.yml` shows file exists
    - `cat .github/workflows/ci.yml | grep "pnpm test"` shows test step
    - `pnpm lint` runs without errors (may have warnings initially)
  </verify>
  <done>GitHub Actions CI workflow created with build, lint, and test steps</done>
</task>

</tasks>

<verification>
1. `pnpm test` runs tests for all workspaces
2. `pnpm lint` runs ESLint across codebase
3. `.github/workflows/ci.yml` exists with correct steps
4. Tests pass for convex, web, and workers apps
5. CI workflow has both build-and-test and type-check jobs
</verification>

<success_criteria>
- GitHub Actions CI runs on push to main and on PRs
- Tests exist for each app (even if minimal)
- Linting configured with shared ESLint config
- Type checking runs across all TypeScript files
- CI caches pnpm dependencies for faster runs
- Vitest workspace configuration works for monorepo
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-06-SUMMARY.md`
</output>
