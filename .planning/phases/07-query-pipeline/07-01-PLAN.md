---
phase: 07-query-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/convex/convex/query/types.ts
  - apps/convex/convex/lib/geocode.ts
  - apps/convex/package.json
autonomous: true

must_haves:
  truths:
    - "Address resolves to array of jurisdictions (US, TX, TX-{fips}, TX-{city})"
    - "Invalid address returns fallback to federal-only jurisdiction"
    - "Geocoding errors are graceful (no pipeline failure)"
  artifacts:
    - path: "apps/convex/convex/query/types.ts"
      provides: "Query pipeline type definitions"
      exports: ["QueryRequest", "QueryResult", "RetrievedChunk", "GeneratedAnswer", "Citation", "Permit", "ConfidenceScore"]
    - path: "apps/convex/convex/lib/geocode.ts"
      provides: "Address-to-jurisdiction resolution"
      exports: ["geocodeAddress", "JurisdictionResult"]
  key_links:
    - from: "apps/convex/convex/lib/geocode.ts"
      to: "Geocodio API"
      via: "fetch with fields=cd,stateleg,census"
      pattern: "api.geocod.io"
---

<objective>
Create query pipeline foundation: TypeScript types and geocoding service.

Purpose: Establishes type contracts for the entire query pipeline and enables address-to-jurisdiction resolution (QUERY-02). The geocoding service converts user addresses into jurisdiction arrays for Pinecone filtering.

Output:
- Query pipeline types (request, result, chunks, citations, permits, confidence)
- Geocodio-based geocoding service with jurisdiction extraction
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-query-pipeline/07-CONTEXT.md
@.planning/phases/07-query-pipeline/07-RESEARCH.md
@apps/workers/src/pinecone.ts
@apps/convex/convex/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create query pipeline types</name>
  <files>apps/convex/convex/query/types.ts</files>
  <action>
Create the query pipeline type definitions in apps/convex/convex/query/types.ts:

1. **QueryRequest** - Input to query pipeline:
   - question: string (natural language question)
   - address: string | undefined (optional address for jurisdiction resolution)
   - conversationId: Id<"conversations"> | undefined (for context)

2. **JurisdictionResult** - Output from geocoding:
   - jurisdictions: string[] (e.g., ["US", "TX", "TX-48201", "TX-houston"])
   - state: string | undefined
   - county: { name: string, fips: string } | undefined
   - city: string | undefined
   - raw: object (original Geocodio response for debugging)

3. **RetrievedChunk** - Pinecone query result with metadata:
   - id: string
   - score: number (similarity 0-1)
   - text: string
   - citation: string
   - jurisdiction: string
   - sourceType: "federal" | "state" | "county" | "municipal"
   - title: string | undefined
   - category: string | undefined
   - url: string | undefined

4. **Citation** - Structured citation in response:
   - id: number (reference number [1], [2], etc.)
   - citation: string (Bluebook format)
   - text: string (quoted source text)
   - url: string | undefined
   - jurisdiction: string
   - sourceType: "federal" | "state" | "county" | "municipal"

5. **Permit** - Required permit/license:
   - name: string (e.g., "Food Establishment Permit")
   - issuingAgency: string (e.g., "Texas Department of State Health Services")
   - jurisdiction: string
   - url: string | undefined (link to application/info)
   - citation: string (regulatory reference)

6. **ConfidenceScore** - Answer confidence:
   - level: "High" | "Medium" | "Low"
   - score: number (0-1)
   - reason: string (explanation)
   - metrics: { avgSimilarity: number, jurisdictionCoverage: number, citationCoverage: number }

7. **JurisdictionSection** - Per-jurisdiction answer section:
   - level: "federal" | "state" | "county" | "municipal"
   - jurisdictionName: string
   - content: string (markdown)
   - citations: Citation[]
   - permits: Permit[]

8. **GeneratedAnswer** - Claude response structure:
   - summary: string (brief answer)
   - sections: JurisdictionSection[]
   - permits: Permit[] (consolidated list)
   - citations: Citation[] (all citations)
   - confidence: ConfidenceScore

9. **QueryResult** - Full pipeline output:
   - queryId: Id<"messages"> | undefined
   - question: string
   - address: string | undefined
   - jurisdictions: string[]
   - answer: GeneratedAnswer
   - retrievedChunks: RetrievedChunk[]
   - processingTimeMs: number

Export all types. Use Convex v validator imports only for Id types.
  </action>
  <verify>
TypeScript compiles without errors:
```bash
cd apps/convex && npx tsc --noEmit
```
  </verify>
  <done>All 9 type definitions exported from apps/convex/convex/query/types.ts</done>
</task>

<task type="auto">
  <name>Task 2: Implement geocoding service</name>
  <files>apps/convex/convex/lib/geocode.ts, apps/convex/package.json</files>
  <action>
Create geocoding service in apps/convex/convex/lib/geocode.ts:

1. **Constants:**
   - GEOCODIO_BASE_URL = "https://api.geocod.io/v1.9/geocode"
   - GEOCODIO_FIELDS = "cd119,stateleg,census" (Congressional district, state leg, census data)

2. **geocodeAddress function:**
   ```typescript
   export async function geocodeAddress(
     address: string,
     apiKey: string
   ): Promise<JurisdictionResult>
   ```

   Implementation:
   - Build URL: `${GEOCODIO_BASE_URL}?q=${encodeURIComponent(address)}&fields=${GEOCODIO_FIELDS}&api_key=${apiKey}`
   - Fetch with try/catch
   - Parse response JSON
   - Extract jurisdictions:
     - Always include "US" (federal)
     - Add state from address_components.state (e.g., "TX")
     - Add county as "TX-{county_fips}" from fields.census.county_fips (e.g., "TX-48201")
     - Add city as "TX-{city_normalized}" where city is lowercase with hyphens (e.g., "TX-houston")
   - Return JurisdictionResult with all fields

3. **Error handling:**
   - If Geocodio returns no results, return { jurisdictions: ["US"], ... } as fallback
   - If fetch fails, log error and return federal-only fallback
   - Never throw - geocoding failure should not break the pipeline

4. **Helper function:**
   ```typescript
   function normalizeCity(city: string): string
   ```
   - Lowercase
   - Replace spaces with hyphens
   - Remove special characters

5. **getFallbackJurisdictions function:**
   ```typescript
   export function getFallbackJurisdictions(): JurisdictionResult
   ```
   - Returns { jurisdictions: ["US"], state: undefined, county: undefined, city: undefined, raw: {} }
   - Used when no address provided or geocoding fails

Import JurisdictionResult from "../query/types".

Do NOT add any dependencies - use native fetch (available in Convex actions).
  </action>
  <verify>
TypeScript compiles:
```bash
cd apps/convex && npx tsc --noEmit
```
  </verify>
  <done>geocodeAddress function extracts federal, state, county, municipal jurisdictions from Geocodio response with graceful fallback</done>
</task>

</tasks>

<verification>
1. apps/convex/convex/query/types.ts exists with all 9 type definitions
2. apps/convex/convex/lib/geocode.ts exists with geocodeAddress, getFallbackJurisdictions, normalizeCity
3. TypeScript compiles: `cd apps/convex && npx tsc --noEmit`
4. Types import correctly in lib/geocode.ts
</verification>

<success_criteria>
- All query pipeline types defined with proper exports
- Geocoding service handles valid addresses, invalid addresses, and API errors gracefully
- No new npm dependencies required (uses native fetch)
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-query-pipeline/07-01-SUMMARY.md`
</output>
