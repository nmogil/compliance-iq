---
phase: 05-municipal-data
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/workers/src/municipal/types.ts
  - apps/workers/src/municipal/cities.ts
  - apps/workers/src/municipal/index.ts
  - apps/workers/src/lib/citations.ts
autonomous: true

must_haves:
  truths:
    - "20 Texas cities defined with Firecrawl configuration"
    - "Municipal ordinance and chunk types support markdown parsing"
    - "Bluebook citations generated for municipal codes"
  artifacts:
    - path: "apps/workers/src/municipal/types.ts"
      provides: "MunicipalOrdinance, MunicipalChunk, MunicipalCityConfig interfaces"
      min_lines: 80
    - path: "apps/workers/src/municipal/cities.ts"
      provides: "TEXAS_CITIES registry with 20 cities (17 Municode, 3 American Legal)"
      exports: ["TEXAS_CITIES", "getEnabledCities", "getCityById"]
    - path: "apps/workers/src/lib/citations.ts"
      provides: "generateMunicipalCitation, generateMunicipalChunkId functions"
      contains: "generateMunicipalCitation"
  key_links:
    - from: "apps/workers/src/municipal/cities.ts"
      to: "apps/workers/src/municipal/types.ts"
      via: "imports MunicipalCityConfig"
      pattern: "import.*MunicipalCityConfig.*from.*types"
---

<objective>
Create municipal type system and 20-city Texas registry with Firecrawl configuration and Bluebook citation generators.

Purpose: Establish foundation for municipal data pipeline with all 20 target cities documented and typed.
Output: Type definitions, city registry, and citation utilities ready for scraper implementation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-municipal-data/05-CONTEXT.md
@.planning/phases/05-municipal-data/05-RESEARCH.md
@apps/workers/src/counties/types.ts
@apps/workers/src/counties/sources.ts
@apps/workers/src/lib/citations.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create municipal type definitions</name>
  <files>apps/workers/src/municipal/types.ts</files>
  <action>
Create type definitions mirroring county phase patterns:

1. **MunicipalOrdinance interface:**
   - cityId: string (URL-safe identifier, e.g., "houston")
   - chapter: string
   - section: string
   - heading: string
   - text: string
   - subsections: Array<{ id: string; text: string }> (for "(a)", "(b)" patterns)
   - sourceUrl: string
   - scrapedAt: Date

2. **MunicipalChunk interface:**
   - chunkId: string (format: municipal-{cityId}-{chapter}-{section}-{index})
   - cityId: string
   - chapter: string
   - section: string
   - text: string (chunk content)
   - citation: string (Bluebook format)
   - hierarchy: string[] (breadcrumbs)
   - sourceUrl: string
   - tokenCount: number

3. **MunicipalCityConfig interface:**
   - name: string (display name, e.g., "Houston")
   - cityId: string (URL-safe, e.g., "houston")
   - platform: 'municode' | 'amlegal' (unified via Firecrawl)
   - baseUrl: string (code library URL)
   - enabled: boolean
   - skipReason?: string (for disabled cities)
   - firecrawlConfig: { waitFor?: number; onlyMainContent?: boolean }

4. **MunicipalCheckpoint interface:**
   - lastProcessedCity?: string
   - processedCities: string[]
   - lastUpdated: string (ISO date)

5. **MunicipalBatchResult interface:**
   - successful: string[]
   - failed: Array<{ city: string; error: string; timestamp: string }>
   - skipped: string[]
   - totalCreditsUsed: number (Firecrawl tracking)

Include JSDoc comments for all interfaces.
  </action>
  <verify>TypeScript compiles: `pnpm --filter @compliance-iq/workers exec tsc --noEmit`</verify>
  <done>All 5 municipal interfaces defined with complete field documentation</done>
</task>

<task type="auto">
  <name>Task 2: Create 20-city Texas registry</name>
  <files>apps/workers/src/municipal/cities.ts</files>
  <action>
Create city registry based on research findings:

**Platform mapping (from 05-RESEARCH.md):**
- Municode (17 cities): Houston, San Antonio, Austin, El Paso, Arlington, Plano, Corpus Christi, Lubbock, Laredo, Irving, Garland, Frisco, McKinney, Amarillo, Grand Prairie, Brownsville, Pasadena
- American Legal (3 cities): Dallas, Fort Worth, Killeen

**Registry structure:**
```typescript
export const TEXAS_CITIES: MunicipalCityConfig[] = [
  {
    name: 'Houston',
    cityId: 'houston',
    platform: 'municode',
    baseUrl: 'https://library.municode.com/tx/houston/codes/code_of_ordinances',
    enabled: true,
    firecrawlConfig: { waitFor: 2000, onlyMainContent: true },
  },
  // ... 19 more cities
];
```

**Base URLs:**
- Houston: https://library.municode.com/tx/houston/codes/code_of_ordinances
- San Antonio: https://library.municode.com/tx/san_antonio/codes/code_of_ordinances
- Dallas: https://codelibrary.amlegal.com/codes/dallas/latest/dallas_tx/0-0-0-1
- Austin: https://library.municode.com/tx/austin/codes/code_of_ordinances
- Fort Worth: https://codelibrary.amlegal.com/codes/ftworth/latest/ftworth_tx/0-0-0-1
- El Paso: https://library.municode.com/tx/el_paso/codes/code_of_ordinances
- Arlington: https://library.municode.com/tx/arlington/codes/code_of_ordinances
- Plano: https://library.municode.com/tx/plano/codes/code_of_ordinances
- Corpus Christi: https://library.municode.com/tx/corpus_christi/codes/code_of_ordinances
- Lubbock: https://library.municode.com/tx/lubbock/codes/code_of_ordinances
- Laredo: https://library.municode.com/tx/laredo/codes/code_of_ordinances
- Irving: https://library.municode.com/tx/irving/codes/code_of_ordinances
- Garland: https://library.municode.com/tx/garland/codes/code_of_ordinances
- Frisco: https://library.municode.com/tx/frisco/codes/code_of_ordinances
- McKinney: https://library.municode.com/tx/mckinney/codes/code_of_ordinances
- Amarillo: https://library.municode.com/tx/amarillo/codes/code_of_ordinances
- Grand Prairie: https://library.municode.com/tx/grand_prairie/codes/code_of_ordinances
- Brownsville: https://library.municode.com/tx/brownsville/codes/code_of_ordinances
- Killeen: https://codelibrary.amlegal.com/codes/killeen/latest/killeen_tx/0-0-0-1
- Pasadena: https://library.municode.com/tx/pasadena/codes/code_of_ordinances

**Helper functions:**
- getEnabledCities(): MunicipalCityConfig[] - Returns all enabled cities
- getSkippedCities(): MunicipalCityConfig[] - Returns disabled cities with reasons
- getCityById(cityId: string): MunicipalCityConfig | undefined
- getCityByName(name: string): MunicipalCityConfig | undefined
- getMunicodeCities(): MunicipalCityConfig[] - Filter by platform
- getAmlegalCities(): MunicipalCityConfig[] - Filter by platform

**Firecrawl config defaults:**
- Municode: waitFor: 2000 (SPA needs rendering time)
- American Legal: waitFor: 1000 (server-rendered, less wait needed)
  </action>
  <verify>Run: `pnpm --filter @compliance-iq/workers exec tsc --noEmit` - no errors on cities.ts</verify>
  <done>20 Texas cities registered with platform mapping and Firecrawl configuration</done>
</task>

<task type="auto">
  <name>Task 3: Add municipal citation generators</name>
  <files>apps/workers/src/lib/citations.ts, apps/workers/src/municipal/index.ts</files>
  <action>
Extend lib/citations.ts with municipal citation utilities (following county pattern):

1. **generateMunicipalCitation(city, section, year?):**
   - Format: "[City], Tex., Code of Ordinances sect. [section] ([year])"
   - Example: "Houston, Tex., Code of Ordinances sect. 1-2 (2026)"

2. **generateMunicipalChunkId(cityId, chapter, section, chunkIndex):**
   - Format: "municipal-{cityId}-{chapter}-{section}-{index}"
   - Example: "municipal-houston-1-1-2-0"

3. **generateMunicipalSourceId(cityId):**
   - Format: "municipal-{cityId}"
   - Example: "municipal-houston"

4. **generateMunicipalUrl(config, section?):**
   - Handles both Municode and American Legal URL patterns
   - Municode: baseUrl + "?nodeId=" + section
   - American Legal: baseUrl + "#" + section

5. **generateMunicipalHierarchy(cityName, chapter, section):**
   - Returns: ["Texas Municipalities", "{cityName}", "Chapter {chapter}", "Section {section}"]

Create apps/workers/src/municipal/index.ts exporting all types and functions:
```typescript
export * from './types';
export * from './cities';
```
  </action>
  <verify>
Run: `pnpm --filter @compliance-iq/workers exec tsc --noEmit`
Verify citations.ts exports new functions without errors.
  </verify>
  <done>5 municipal citation functions added to lib/citations.ts, municipal module exports configured</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `pnpm --filter @compliance-iq/workers exec tsc --noEmit`
2. All 20 cities registered in TEXAS_CITIES array
3. Platform distribution: 17 Municode, 3 American Legal
4. All helper functions exported from municipal/index.ts
5. Citation functions produce expected Bluebook format
</verification>

<success_criteria>
- 5 TypeScript interfaces defined (MunicipalOrdinance, MunicipalChunk, MunicipalCityConfig, MunicipalCheckpoint, MunicipalBatchResult)
- 20 Texas cities registered with correct platform and base URL
- 5 citation functions added (generateMunicipalCitation, generateMunicipalChunkId, generateMunicipalSourceId, generateMunicipalUrl, generateMunicipalHierarchy)
- All exports available from municipal/index.ts
</success_criteria>

<output>
After completion, create `.planning/phases/05-municipal-data/05-01-SUMMARY.md`
</output>
