---
phase: 03-state-data
plan: 03
type: execute
wave: 2
depends_on: ["03-01", "03-02"]
files_modified:
  - apps/workers/src/texas/fetch-statutes.ts
  - apps/workers/src/texas/parse-statutes.ts
autonomous: true

must_haves:
  truths:
    - "Scraper fetches Texas statute HTML from capitol.texas.gov"
    - "Cheerio parses statute sections with heading and text extraction"
    - "Scraper handles missing pages gracefully (404 -> skip)"
  artifacts:
    - path: "apps/workers/src/texas/fetch-statutes.ts"
      provides: "fetchTexasStatute, fetchTexasCode, discoverCodeChapters functions"
      exports: ["fetchTexasStatute", "fetchTexasCode", "discoverCodeChapters"]
      min_lines: 80
    - path: "apps/workers/src/texas/parse-statutes.ts"
      provides: "parseStatuteHTML, extractSectionText functions"
      exports: ["parseStatuteHTML", "extractSectionText"]
      min_lines: 60
  key_links:
    - from: "apps/workers/src/texas/fetch-statutes.ts"
      to: "apps/workers/src/lib/scraper.ts"
      via: "fetchWithRateLimit import"
      pattern: "import.*fetchWithRateLimit.*scraper"
    - from: "apps/workers/src/texas/parse-statutes.ts"
      to: "cheerio"
      via: "cheerio.load"
      pattern: "cheerio\\.load"
---

<objective>
Create Texas Statutes fetcher and HTML parser using Cheerio.

Purpose: Scrape Texas statutes from capitol.texas.gov with rate-limited requests and parse HTML into structured TexasStatuteSection objects. This plan covers the "fetch" portion of the pipeline for Texas Statutes (30 codes).

Output:
- Statute fetcher with rate limiting and error handling
- Cheerio-based HTML parser for statute sections
- Chapter/section discovery for each code
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-state-data/03-RESEARCH.md
@.planning/phases/03-state-data/03-01-SUMMARY.md
@.planning/phases/03-state-data/03-02-SUMMARY.md

# Reference existing fetch pattern
@apps/workers/src/federal/fetch.ts
@apps/workers/src/texas/types.ts
@apps/workers/src/lib/scraper.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Texas Statutes HTML parser with Cheerio</name>
  <files>apps/workers/src/texas/parse-statutes.ts</files>
  <action>
Create apps/workers/src/texas/parse-statutes.ts for parsing capitol.texas.gov HTML:

```typescript
/**
 * Texas Statutes HTML Parser
 *
 * Parses HTML from capitol.texas.gov statute pages using Cheerio.
 * Extracts section headings, text, and subsection structure.
 */

import * as cheerio from 'cheerio';
import type { TexasStatuteSection, TexasSubsection } from './types';
```

Implement the following functions:

1. **parseStatuteHTML(html: string, code: string, section: string, sourceUrl: string): TexasStatuteSection**
   - Load HTML with cheerio.load(html)
   - Extract section heading from appropriate HTML element (inspect actual HTML structure)
   - Extract full section text
   - Parse subsections if present
   - Add scrapedAt timestamp
   - Return TexasStatuteSection object

   **HTML Structure Notes (verify during implementation):**
   - Capitol.texas.gov serves statute sections as HTML pages
   - Section heading typically in <h2> or similar
   - Section text in body content
   - Subsections marked with (a), (b), etc. in text
   - Use flexible selectors that handle structure variations

2. **extractSectionText($: cheerio.CheerioAPI): string**
   - Extract main section text content
   - Preserve paragraph structure
   - Normalize whitespace
   - Remove navigation/footer content

3. **extractSubsections(text: string): TexasSubsection[]**
   - Parse subsection markers: (a), (b), (1), (2), etc.
   - Extract text for each subsection
   - Handle nested subsections: (a)(1), (b)(2)(i)
   - Return array of TexasSubsection objects

4. **extractSectionHeading($: cheerio.CheerioAPI): string**
   - Find section heading element
   - Extract and clean heading text
   - Handle cases where heading might be missing

5. **validateParsedSection(section: TexasStatuteSection): void**
   - Throw error if text is empty or too short (< 10 chars)
   - Log warning if heading is missing
   - Validate section structure

**Error Handling:**
- Throw descriptive errors if HTML structure doesn't match expectations
- Log warnings for non-critical parsing issues
- Include URL in error messages for debugging

**Selector Strategy (flexible approach):**
```typescript
// Try multiple selectors, use first that works
const headingSelectors = ['h2.section-heading', 'h2', '.statute-heading', 'h1 + h2'];
const textSelectors = ['.section-text', '.statute-body', 'article', 'main'];
```

Add comprehensive JSDoc comments and export all public functions.
  </action>
  <verify>
```bash
cd /Users/noahmogil/Projects/compliance-iq && pnpm -F @compliance-iq/workers exec tsc --noEmit apps/workers/src/texas/parse-statutes.ts
```
TypeScript compiles without errors.
  </verify>
  <done>
Statute HTML parser created with Cheerio-based extraction. Functions handle heading, text, and subsection parsing.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Texas Statutes fetcher with rate limiting</name>
  <files>apps/workers/src/texas/fetch-statutes.ts</files>
  <action>
Create apps/workers/src/texas/fetch-statutes.ts for fetching from capitol.texas.gov:

```typescript
/**
 * Texas Statutes Fetcher
 *
 * Fetches statute HTML from capitol.texas.gov with rate limiting
 * and retry logic. Implements chapter/section discovery.
 */

import { fetchWithRateLimit, NotFoundError } from '../lib/scraper';
import { generateStatuteUrl } from '../lib/citations';
import { parseStatuteHTML } from './parse-statutes';
import type { TexasStatuteSection, TexasCodeConfig } from './types';
```

Implement the following functions:

1. **fetchStatuteHTML(code: string, section: string): Promise<string>**
   - Generate URL using generateStatuteUrl(code, section)
   - Call fetchWithRateLimit with 200ms delay between requests
   - Return HTML text
   - Handle 404 gracefully (NotFoundError)

2. **fetchTexasStatute(code: string, section: string): Promise<TexasStatuteSection>**
   - Fetch HTML using fetchStatuteHTML
   - Parse using parseStatuteHTML
   - Return structured TexasStatuteSection
   - Log progress: "[TX Statutes] Fetched {code} ยง {section}"

3. **discoverCodeChapters(code: string): Promise<string[]>**
   - Fetch code table of contents page from capitol.texas.gov
   - Parse to find all chapter numbers
   - Return array of chapter identifiers
   - Handle codes with different TOC structures

   **TOC URL pattern (verify):**
   `https://statutes.capitol.texas.gov/Docs/{CODE}/htm/{CODE}.htm`

4. **discoverChapterSections(code: string, chapter: string): Promise<string[]>**
   - Fetch chapter page
   - Parse to find all section numbers within chapter
   - Return array of section identifiers (e.g., ["30.01", "30.02", "30.03"])

5. **fetchTexasCode(codeConfig: TexasCodeConfig): AsyncGenerator<TexasStatuteSection>**
   - Discover all chapters for the code
   - For each chapter, discover all sections
   - Yield each section as fetched/parsed
   - Skip NotFoundError sections (log and continue)
   - Use AsyncGenerator for memory-efficient streaming

   ```typescript
   export async function* fetchTexasCode(
     codeConfig: TexasCodeConfig
   ): AsyncGenerator<TexasStatuteSection> {
     console.log(`[TX Statutes] Fetching code: ${codeConfig.abbreviation} (${codeConfig.name})`);

     const chapters = await discoverCodeChapters(codeConfig.abbreviation);
     console.log(`[TX Statutes] Found ${chapters.length} chapters in ${codeConfig.abbreviation}`);

     for (const chapter of chapters) {
       const sections = await discoverChapterSections(codeConfig.abbreviation, chapter);

       for (const section of sections) {
         try {
           const statuteSection = await fetchTexasStatute(codeConfig.abbreviation, section);
           yield statuteSection;
         } catch (error) {
           if (error instanceof NotFoundError) {
             console.warn(`[TX Statutes] Section not found: ${codeConfig.abbreviation} ยง ${section}`);
             continue;
           }
           throw error;
         }
       }
     }
   }
   ```

**Rate Limiting Configuration:**
- 200ms minimum delay between requests to capitol.texas.gov
- Use fetchWithRateLimit from scraper.ts
- Respect Retry-After headers

**User-Agent:**
- Set descriptive User-Agent: "ComplianceIQ-Bot/1.0 (Legal research tool)"

**Error Handling:**
- NotFoundError: Log warning, skip section, continue
- RateLimitError: Will be handled by scraper.ts retry logic
- ScrapingError: Log error, may continue or rethrow depending on severity

Export all public functions.
  </action>
  <verify>
```bash
cd /Users/noahmogil/Projects/compliance-iq && pnpm -F @compliance-iq/workers exec tsc --noEmit apps/workers/src/texas/fetch-statutes.ts
```
TypeScript compiles without errors.
  </verify>
  <done>
Statute fetcher created with:
- Rate-limited requests to capitol.texas.gov
- Chapter/section discovery
- AsyncGenerator for memory-efficient streaming
- Graceful handling of missing sections
  </done>
</task>

<task type="auto">
  <name>Task 3: Create index.ts for texas module exports</name>
  <files>apps/workers/src/texas/index.ts</files>
  <action>
Create apps/workers/src/texas/index.ts to export the module's public API:

```typescript
/**
 * Texas State Data Pipeline Module
 *
 * Provides scraping, parsing, and processing for Texas Statutes
 * and Texas Administrative Code (TAC).
 */

// Types
export * from './types';

// Statute fetcher and parser
export { fetchTexasStatute, fetchTexasCode, discoverCodeChapters } from './fetch-statutes';
export { parseStatuteHTML, extractSectionText } from './parse-statutes';

// Future: TAC fetcher and parser (03-05)
// export { fetchTACRule, fetchTACTitle } from './fetch-tac';
// export { parseTACHTML } from './parse-tac';

// Future: Storage and chunking (03-04)
// export { storeTexasStatute, saveTexasCheckpoint } from './storage';
// export { chunkTexasStatute } from './chunk';

// Future: Pipeline orchestrator (03-06)
// export { processTexasStatutes, processAllTexasSources } from './pipeline';
```

This provides a clean module interface that will grow as subsequent plans add more functionality.
  </action>
  <verify>
```bash
cd /Users/noahmogil/Projects/compliance-iq && pnpm -F @compliance-iq/workers exec tsc --noEmit apps/workers/src/texas/index.ts
```
TypeScript compiles without errors.
  </verify>
  <done>
Texas module index created with public API exports. Future exports commented for clarity.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Run full TypeScript check:
```bash
cd /Users/noahmogil/Projects/compliance-iq && pnpm -F @compliance-iq/workers exec tsc --noEmit
```

2. Verify texas module files:
```bash
ls -la /Users/noahmogil/Projects/compliance-iq/apps/workers/src/texas/
```

3. Verify exports from index:
```bash
grep -n "export" /Users/noahmogil/Projects/compliance-iq/apps/workers/src/texas/index.ts
```
</verification>

<success_criteria>
- apps/workers/src/texas/fetch-statutes.ts exports fetchTexasStatute, fetchTexasCode
- apps/workers/src/texas/parse-statutes.ts exports parseStatuteHTML, extractSectionText
- apps/workers/src/texas/index.ts exports all public functions
- Cheerio used for HTML parsing
- Rate limiting via fetchWithRateLimit from scraper.ts
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-state-data/03-03-SUMMARY.md`
</output>
