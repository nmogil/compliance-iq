---
phase: 03-state-data
plan: 05
type: execute
wave: 2
depends_on: ["03-01", "03-02"]
files_modified:
  - apps/workers/src/texas/fetch-tac.ts
  - apps/workers/src/texas/parse-tac.ts
  - apps/workers/src/texas/chunk.ts
autonomous: true

must_haves:
  truths:
    - "Scraper fetches TAC rules from sos.state.tx.us"
    - "Cheerio parses TAC HTML with rule heading and text extraction"
    - "TAC chunks have tx-tac sourceType and proper citations"
  artifacts:
    - path: "apps/workers/src/texas/fetch-tac.ts"
      provides: "fetchTACRule, fetchTACTitle, discoverTACChapters functions"
      exports: ["fetchTACRule", "fetchTACTitle", "discoverTACChapters"]
      min_lines: 80
    - path: "apps/workers/src/texas/parse-tac.ts"
      provides: "parseTACHTML, extractTACRuleText functions"
      exports: ["parseTACHTML", "extractTACRuleText"]
      min_lines: 50
  key_links:
    - from: "apps/workers/src/texas/fetch-tac.ts"
      to: "apps/workers/src/lib/scraper.ts"
      via: "fetchWithRateLimit import"
      pattern: "import.*fetchWithRateLimit.*scraper"
    - from: "apps/workers/src/texas/parse-tac.ts"
      to: "cheerio"
      via: "cheerio.load"
      pattern: "cheerio\\.load"
---

<objective>
Create Texas Administrative Code (TAC) fetcher and HTML parser.

Purpose: Scrape TAC from sos.state.tx.us with rate-limited requests and parse HTML into structured TACRule objects. Covers 5 target TAC titles relevant to retail compliance (16, 22, 25, 30, 37).

Output:
- TAC fetcher with rate limiting and error handling
- Cheerio-based HTML parser for TAC rules
- Title/chapter/rule discovery
- TAC chunking additions to chunk.ts
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-state-data/03-RESEARCH.md
@.planning/phases/03-state-data/03-01-SUMMARY.md
@.planning/phases/03-state-data/03-02-SUMMARY.md

# Reference patterns
@apps/workers/src/texas/fetch-statutes.ts
@apps/workers/src/texas/parse-statutes.ts
@apps/workers/src/texas/types.ts
@apps/workers/src/lib/scraper.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TAC HTML parser with Cheerio</name>
  <files>apps/workers/src/texas/parse-tac.ts</files>
  <action>
Create apps/workers/src/texas/parse-tac.ts for parsing sos.state.tx.us TAC HTML:

```typescript
/**
 * Texas Administrative Code HTML Parser
 *
 * Parses HTML from sos.state.tx.us TAC pages using Cheerio.
 * Extracts rule headings, text, and subsection structure.
 */

import * as cheerio from 'cheerio';
import type { TACRule, TexasSubsection } from './types';
```

Implement the following functions:

1. **parseTACHTML(html: string, title: number, chapter: string, section: string, sourceUrl: string): TACRule**
   - Load HTML with cheerio.load(html)
   - Extract rule heading from appropriate HTML element
   - Extract full rule text
   - Parse subsections if present
   - Add scrapedAt timestamp
   - Return TACRule object

   **TAC HTML Structure Notes (verify during implementation):**
   - SOS website serves TAC pages as HTML
   - Rule heading typically in header element
   - Rule text in body content
   - Subsections marked with (a), (b), etc.
   - Use flexible selectors for structure variations

2. **extractTACRuleText($: cheerio.CheerioAPI): string**
   - Extract main rule text content
   - Preserve paragraph structure
   - Normalize whitespace
   - Remove navigation/footer content

3. **extractTACRuleHeading($: cheerio.CheerioAPI): string**
   - Find rule heading element
   - Extract and clean heading text
   - Handle cases where heading might be missing

4. **validateParsedTACRule(rule: TACRule): void**
   - Throw error if text is empty or too short
   - Log warning if heading is missing
   - Validate rule structure

**Flexible Selector Strategy:**
```typescript
const headingSelectors = ['.rule-heading', 'h2', '.tac-heading', 'h1 + h2'];
const textSelectors = ['.rule-text', '.tac-body', 'article', 'main', '.content'];
```

Add comprehensive JSDoc comments and export all public functions.
  </action>
  <verify>
```bash
cd /Users/noahmogil/Projects/compliance-iq && pnpm -F @compliance-iq/workers exec tsc --noEmit apps/workers/src/texas/parse-tac.ts
```
TypeScript compiles without errors.
  </verify>
  <done>
TAC HTML parser created with Cheerio-based extraction. Functions handle heading, text, and subsection parsing.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create TAC fetcher with rate limiting</name>
  <files>apps/workers/src/texas/fetch-tac.ts</files>
  <action>
Create apps/workers/src/texas/fetch-tac.ts for fetching from sos.state.tx.us:

```typescript
/**
 * Texas Administrative Code Fetcher
 *
 * Fetches TAC HTML from sos.state.tx.us with rate limiting
 * and retry logic. Implements title/chapter/rule discovery.
 */

import { fetchWithRateLimit, NotFoundError } from '../lib/scraper';
import { generateTACUrl } from '../lib/citations';
import { parseTACHTML } from './parse-tac';
import type { TACRule, TACTitleConfig } from './types';
```

Implement the following functions:

1. **fetchTACHTML(title: number, section: string): Promise<string>**
   - Generate URL using generateTACUrl(title, section)
   - Call fetchWithRateLimit with 200ms delay
   - Return HTML text
   - Handle 404 gracefully

2. **fetchTACRule(title: number, chapter: string, section: string): Promise<TACRule>**
   - Fetch HTML using fetchTACHTML
   - Parse using parseTACHTML
   - Return structured TACRule
   - Log progress: "[TX TAC] Fetched Title {title} ยง {section}"

3. **discoverTACChapters(title: number): Promise<string[]>**
   - Fetch TAC title table of contents from SOS
   - Parse to find all chapter numbers
   - Return array of chapter identifiers

   **TOC URL pattern (verify during implementation):**
   `https://texreg.sos.state.tx.us/public/readtac$ext.ViewTAC?tac_view=3&ti={title}`

4. **discoverChapterRules(title: number, chapter: string): Promise<string[]>**
   - Fetch chapter page
   - Parse to find all rule/section numbers within chapter
   - Return array of section identifiers

5. **fetchTACTitle(titleConfig: TACTitleConfig): AsyncGenerator<TACRule>**
   - Discover all chapters for the title
   - For each chapter, discover all rules
   - Yield each rule as fetched/parsed
   - Skip NotFoundError rules (log and continue)
   - Use AsyncGenerator for memory-efficient streaming

   ```typescript
   export async function* fetchTACTitle(
     titleConfig: TACTitleConfig
   ): AsyncGenerator<TACRule> {
     console.log(`[TX TAC] Fetching title: ${titleConfig.number} (${titleConfig.name})`);

     const chapters = await discoverTACChapters(titleConfig.number);
     console.log(`[TX TAC] Found ${chapters.length} chapters in Title ${titleConfig.number}`);

     for (const chapter of chapters) {
       const rules = await discoverChapterRules(titleConfig.number, chapter);

       for (const rule of rules) {
         try {
           const tacRule = await fetchTACRule(titleConfig.number, chapter, rule);
           yield tacRule;
         } catch (error) {
           if (error instanceof NotFoundError) {
             console.warn(`[TX TAC] Rule not found: Title ${titleConfig.number} ยง ${rule}`);
             continue;
           }
           throw error;
         }
       }
     }
   }
   ```

**Rate Limiting:**
- 200ms minimum delay between requests to sos.state.tx.us
- Use fetchWithRateLimit from scraper.ts
- Respect Retry-After headers

Export all public functions.
  </action>
  <verify>
```bash
cd /Users/noahmogil/Projects/compliance-iq && pnpm -F @compliance-iq/workers exec tsc --noEmit apps/workers/src/texas/fetch-tac.ts
```
TypeScript compiles without errors.
  </verify>
  <done>
TAC fetcher created with:
- Rate-limited requests to sos.state.tx.us
- Title/chapter/rule discovery
- AsyncGenerator for memory-efficient streaming
- Graceful handling of missing rules
  </done>
</task>

<task type="auto">
  <name>Task 3: Add TAC chunking to chunk.ts</name>
  <files>apps/workers/src/texas/chunk.ts</files>
  <action>
Extend apps/workers/src/texas/chunk.ts to support TAC chunking:

Add imports:
```typescript
import type { TACRule, TACTitleConfig } from './types';
import {
  generateTACCitation,
  generateTACUrl,
} from '../lib/citations';
```

Add new interface:
```typescript
export interface TACChunkContext {
  title: number;
  titleName: string;
  chapter: string;
  category?: string;
}
```

Add new functions:

1. **chunkTACRule(rule: TACRule, context: TACChunkContext): TexasChunk[]**
   - Count tokens in rule.text
   - If โค MAX_CHUNK_TOKENS: return single chunk
   - If > MAX_CHUNK_TOKENS: split at subsection boundaries
   - Generate citation using generateTACCitation
   - Generate URL using generateTACUrl
   - Set sourceType: 'tx-tac'
   - Include tacTitle, chapter, section fields

   ```typescript
   export function chunkTACRule(
     rule: TACRule,
     context: TACChunkContext
   ): TexasChunk[] {
     const tokenCount = countTokens(rule.text);

     if (tokenCount <= MAX_CHUNK_TOKENS) {
       return [{
         chunkId: generateTexasChunkId('tac', context.title, context.chapter, rule.section, 0),
         sourceId: generateTexasSourceId('tac', context.title),
         sourceType: 'tx-tac',
         text: rule.text,
         citation: generateTACCitation(context.title, rule.section),
         url: generateTACUrl(context.title, rule.section),
         tacTitle: context.title,
         chapter: context.chapter,
         section: rule.section,
         hierarchy: generateTexasHierarchy('tac', context.title, context.titleName, context.chapter, rule.section),
         category: context.category,
         chunkIndex: 0,
         totalChunks: 1,
       }];
     }

     return splitTACRule(rule, context);
   }
   ```

2. **splitTACRule(rule: TACRule, context: TACChunkContext): TexasChunk[]**
   - Parse subsections from rule.text
   - Create chunk per subsection
   - If subsection still too large, split with overlap

3. **chunkTACTitle(rules: TACRule[], titleConfig: TACTitleConfig): TexasChunk[]**
   - Batch chunking for entire title
   - Returns flat array of all chunks
   - Logs statistics

Update exports in chunk.ts and index.ts.
  </action>
  <verify>
```bash
cd /Users/noahmogil/Projects/compliance-iq && pnpm -F @compliance-iq/workers exec tsc --noEmit apps/workers/src/texas/chunk.ts
```
TypeScript compiles without errors.
  </verify>
  <done>
TAC chunking added to chunk.ts with:
- chunkTACRule function for individual rules
- chunkTACTitle function for batch processing
- tx-tac sourceType for TAC chunks
- Proper TAC citation format
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Run full TypeScript check:
```bash
cd /Users/noahmogil/Projects/compliance-iq && pnpm -F @compliance-iq/workers exec tsc --noEmit
```

2. Verify new files:
```bash
ls -la /Users/noahmogil/Projects/compliance-iq/apps/workers/src/texas/
```

3. Check TAC-related exports:
```bash
grep -n "TAC\|tac" /Users/noahmogil/Projects/compliance-iq/apps/workers/src/texas/index.ts
```
</verification>

<success_criteria>
- apps/workers/src/texas/fetch-tac.ts exports fetchTACRule, fetchTACTitle
- apps/workers/src/texas/parse-tac.ts exports parseTACHTML
- apps/workers/src/texas/chunk.ts exports chunkTACRule, chunkTACTitle
- TAC chunks have tx-tac sourceType
- TAC citations follow "[Title] Tex. Admin. Code ยง [section]" format
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-state-data/03-05-SUMMARY.md`
</output>
