---
phase: 03-state-data
plan: 06
type: execute
wave: 4
depends_on: ["03-04", "03-05"]
files_modified:
  - apps/workers/src/texas/pipeline.ts
  - apps/workers/src/index.ts
autonomous: true

must_haves:
  truths:
    - "Pipeline orchestrates fetch -> store -> chunk -> embed -> index for Texas sources"
    - "HTTP endpoints trigger Texas pipeline manually"
    - "Checkpoint-based resumption enables failure recovery"
    - "Pinecone vectors have tx-state jurisdiction metadata"
  artifacts:
    - path: "apps/workers/src/texas/pipeline.ts"
      provides: "processTexasStatutes, processTexasTAC, processAllTexasSources functions"
      exports: ["processTexasStatutes", "processTexasTAC", "processAllTexasSources"]
      min_lines: 200
    - path: "apps/workers/src/index.ts"
      provides: "POST /pipeline/texas, POST /pipeline/texas/statutes, POST /pipeline/texas/tac endpoints"
      min_lines: 150
  key_links:
    - from: "apps/workers/src/texas/pipeline.ts"
      to: "apps/workers/src/pinecone.ts"
      via: "upsertChunks"
      pattern: "upsertChunks"
    - from: "apps/workers/src/texas/pipeline.ts"
      to: "apps/workers/src/federal/embed.ts"
      via: "embedChunks"
      pattern: "embedChunks"
    - from: "apps/workers/src/texas/pipeline.ts"
      to: "apps/workers/src/texas/storage.ts"
      via: "storeTACRule for TAC storage wiring"
      pattern: "storeTACRule"
    - from: "apps/workers/src/index.ts"
      to: "apps/workers/src/texas/pipeline.ts"
      via: "processAllTexasSources"
      pattern: "import.*processAllTexasSources.*texas"
---

<objective>
Create Texas data pipeline orchestrator and HTTP endpoints.

Purpose: End-to-end pipeline that orchestrates fetch -> store -> chunk -> embed -> index for Texas Statutes and TAC. Mirrors the federal pipeline pattern from Phase 2 with checkpointing and Convex sync.

Output:
- Pipeline orchestrator for Texas sources
- HTTP endpoints for manual triggering
- Pinecone indexing with tx-state jurisdiction
- Convex freshness tracking
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-state-data/03-RESEARCH.md
@.planning/phases/03-state-data/03-04-SUMMARY.md
@.planning/phases/03-state-data/03-05-SUMMARY.md

# Reference existing patterns
@apps/workers/src/federal/pipeline.ts
@apps/workers/src/index.ts
@apps/workers/src/pinecone.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Texas pipeline orchestrator</name>
  <files>apps/workers/src/texas/pipeline.ts</files>
  <action>
Create apps/workers/src/texas/pipeline.ts following the federal/pipeline.ts pattern:

```typescript
/**
 * Texas State Data Pipeline Orchestrator
 *
 * End-to-end pipeline for fetching, storing, chunking, embedding, and indexing
 * Texas Statutes and TAC data. Implements checkpoint-based resumption.
 *
 * Pipeline Flow:
 * 1. Load checkpoint (if exists) to resume from last position
 * 2. Fetch source HTML (statutes or TAC)
 * 3. Store raw HTML in R2
 * 4. Chunk sections into embeddings-ready chunks
 * 5. Generate embeddings via OpenAI
 * 6. Upsert vectors to Pinecone with metadata
 * 7. Save checkpoint after each code/title
 * 8. Clear checkpoint on completion
 * 9. Sync freshness to Convex
 */

import type { Env } from '../types';
import {
  TARGET_STATUTES,
  TARGET_TAC_TITLES,
  getCategoriesForCode,
  getCategoriesForTACTitle,
  type TexasCodeConfig,
  type TACTitleConfig,
  type TexasChunk,
} from './types';
import { fetchTexasCode } from './fetch-statutes';
import { fetchTACTitle } from './fetch-tac';
import {
  storeTexasStatute,
  storeTACRule,
  saveTexasCheckpoint,
  loadTexasCheckpoint,
  clearTexasCheckpoint,
} from './storage';
import { chunkTexasStatute, chunkTACRule } from './chunk';
import { embedChunks } from '../federal/embed'; // Reuse federal embed
import { initPinecone, getIndex, upsertChunks } from '../pinecone';
```

**Result interfaces:**
```typescript
export interface TexasPipelineResult {
  sourceType: 'statute' | 'tac';
  identifier: string; // Code abbreviation or TAC title number
  success: boolean;
  sectionsProcessed: number;
  chunksCreated: number;
  vectorsUpserted: number;
  durationMs: number;
  errors?: string[];
}

export interface TexasBatchPipelineResult {
  success: boolean;
  statutesProcessed: number;
  tacTitlesProcessed: number;
  totalChunks: number;
  totalVectors: number;
  durationMs: number;
  results: TexasPipelineResult[];
}
```

**Main functions:**

1. **processTexasCode(codeConfig: TexasCodeConfig, env: Env): Promise<TexasPipelineResult>**
   - Load checkpoint for statutes
   - Resume from last processed code if checkpoint exists
   - Fetch sections using fetchTexasCode generator
   - For each section:
     - Store raw HTML in R2
     - Chunk section
     - Generate embeddings
     - Prepare Pinecone records with metadata:
       ```typescript
       {
         chunkId: chunk.chunkId,
         sourceId: chunk.sourceId,
         sourceType: 'tx-statute',
         jurisdiction: 'TX', // State jurisdiction
         text: chunk.text,
         citation: chunk.citation,
         chunkIndex: chunk.chunkIndex,
         totalChunks: chunk.totalChunks,
         category: chunk.category,
         indexedAt: new Date().toISOString(),
       }
       ```
     - Upsert to Pinecone
   - Save checkpoint after each chapter
   - Clear checkpoint on completion
   - Return result

2. **processTexasTACTitle(titleConfig: TACTitleConfig, env: Env): Promise<TexasPipelineResult>**
   - Load checkpoint for TAC
   - Resume from last processed title if checkpoint exists
   - Fetch rules using fetchTACTitle generator
   - For each rule:
     - **Store raw HTML in R2 using storeTACRule(bucket, rule, html)** (parallel to storeTexasStatute for statutes)
     - Chunk rule using chunkTACRule
     - Generate embeddings
     - Prepare Pinecone records with metadata:
       ```typescript
       {
         chunkId: chunk.chunkId,
         sourceId: chunk.sourceId,
         sourceType: 'tx-tac',
         jurisdiction: 'TX',
         text: chunk.text,
         citation: chunk.citation,
         chunkIndex: chunk.chunkIndex,
         totalChunks: chunk.totalChunks,
         category: chunk.category,
         indexedAt: new Date().toISOString(),
       }
       ```
     - Upsert to Pinecone
   - Save checkpoint after each chapter
   - Clear checkpoint on completion
   - Return result

3. **processTexasStatutes(env: Env): Promise<TexasBatchPipelineResult>**
   - Process all enabled TARGET_STATUTES sequentially
   - Aggregate results
   - Sync to Convex

4. **processTexasTAC(env: Env): Promise<TexasBatchPipelineResult>**
   - Process all 5 TARGET_TAC_TITLES sequentially
   - Aggregate results
   - Sync to Convex

5. **processAllTexasSources(env: Env): Promise<TexasBatchPipelineResult>**
   - Run statutes pipeline
   - Run TAC pipeline
   - Aggregate all results
   - Sync combined status to Convex

6. **syncConvexTexasSources(env: Env, results: TexasBatchPipelineResult): Promise<void>**
   - Call Convex mutation to update Texas source freshness
   - Best-effort operation (log errors, don't fail pipeline)

**Batch processing notes:**
- Process codes/titles sequentially to avoid overwhelming APIs
- Use 200ms delay between requests (via scraper.ts)
- Batch embeddings in groups of 64 (reuse federal embed pattern)
- Continue processing even if individual codes/titles fail

Export all public functions.
  </action>
  <verify>
```bash
cd /Users/noahmogil/Projects/compliance-iq && pnpm -F @compliance-iq/workers exec tsc --noEmit apps/workers/src/texas/pipeline.ts
```
TypeScript compiles without errors.
  </verify>
  <done>
Pipeline orchestrator created with:
- processTexasCode for individual statute codes
- processTexasTACTitle for individual TAC titles
- processTexasStatutes for all statutes
- processTexasTAC for all TAC titles
- processAllTexasSources for complete pipeline
- Checkpoint-based resumption
- Pinecone indexing with TX jurisdiction
- Convex freshness sync
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Texas HTTP endpoints to main worker</name>
  <files>apps/workers/src/index.ts</files>
  <action>
Extend apps/workers/src/index.ts to add Texas pipeline endpoints:

Add imports:
```typescript
import {
  processTexasStatutes,
  processTexasTAC,
  processAllTexasSources,
  processTexasCode,
  processTexasTACTitle,
} from './texas/pipeline';
import { TARGET_STATUTES, TARGET_TAC_TITLES } from './texas/types';
```

Update health check endpoint to include new endpoints:
```typescript
endpoints: [
  'GET /health - Health check',
  'GET /documents - List R2 documents',
  'POST /pipeline/federal - Trigger full federal pipeline (7 titles)',
  'POST /pipeline/federal/:title - Trigger single CFR title pipeline',
  'POST /pipeline/texas - Trigger full Texas pipeline (statutes + TAC)',
  'POST /pipeline/texas/statutes - Trigger Texas Statutes pipeline (30 codes)',
  'POST /pipeline/texas/tac - Trigger Texas TAC pipeline (5 titles)',
  'POST /pipeline/texas/statutes/:code - Trigger single code pipeline',
  'POST /pipeline/texas/tac/:title - Trigger single TAC title pipeline',
],
```

Add new route handlers:

1. **POST /pipeline/texas** - Full Texas pipeline:
```typescript
if (url.pathname === '/pipeline/texas' && request.method === 'POST') {
  try {
    console.log('[Worker] Starting full Texas pipeline');
    const result = await processAllTexasSources(env);
    return new Response(JSON.stringify(result), {
      headers: { 'Content-Type': 'application/json' },
    });
  } catch (error) {
    console.error('[Worker] Texas pipeline failed:', error);
    return new Response(
      JSON.stringify({
        error: 'Pipeline failed',
        message: error instanceof Error ? error.message : 'Unknown error',
      }),
      {
        status: 500,
        headers: { 'Content-Type': 'application/json' },
      }
    );
  }
}
```

2. **POST /pipeline/texas/statutes** - Texas Statutes only
3. **POST /pipeline/texas/tac** - Texas TAC only
4. **POST /pipeline/texas/statutes/:code** - Single statute code:
```typescript
const statuteMatch = url.pathname.match(/^\/pipeline\/texas\/statutes\/([A-Z]{2})$/);
if (statuteMatch && statuteMatch[1] && request.method === 'POST') {
  const code = statuteMatch[1];
  const codeConfig = TARGET_STATUTES.find(c => c.abbreviation === code);

  if (!codeConfig) {
    return new Response(
      JSON.stringify({ error: `Unknown code: ${code}` }),
      { status: 400, headers: { 'Content-Type': 'application/json' } }
    );
  }

  try {
    console.log(`[Worker] Starting pipeline for Texas ${code}`);
    const result = await processTexasCode(codeConfig, env);
    return new Response(JSON.stringify(result), {
      headers: { 'Content-Type': 'application/json' },
    });
  } catch (error) {
    console.error(`[Worker] Pipeline failed for ${code}:`, error);
    return new Response(
      JSON.stringify({
        error: 'Pipeline failed',
        message: error instanceof Error ? error.message : 'Unknown error',
      }),
      {
        status: 500,
        headers: { 'Content-Type': 'application/json' },
      }
    );
  }
}
```

5. **POST /pipeline/texas/tac/:title** - Single TAC title
  </action>
  <verify>
```bash
cd /Users/noahmogil/Projects/compliance-iq && pnpm -F @compliance-iq/workers exec tsc --noEmit apps/workers/src/index.ts
```
TypeScript compiles without errors.
  </verify>
  <done>
HTTP endpoints added:
- POST /pipeline/texas (full pipeline)
- POST /pipeline/texas/statutes (statutes only)
- POST /pipeline/texas/tac (TAC only)
- POST /pipeline/texas/statutes/:code (single code)
- POST /pipeline/texas/tac/:title (single title)
  </done>
</task>

<task type="auto">
  <name>Task 3: Update texas/index.ts with pipeline exports</name>
  <files>apps/workers/src/texas/index.ts</files>
  <action>
Update apps/workers/src/texas/index.ts with complete exports:

```typescript
/**
 * Texas State Data Pipeline Module
 *
 * Provides scraping, parsing, storage, and processing for Texas Statutes
 * and Texas Administrative Code (TAC).
 */

// Types
export * from './types';

// Statute fetcher and parser
export { fetchTexasStatute, fetchTexasCode, discoverCodeChapters } from './fetch-statutes';
export { parseStatuteHTML, extractSectionText } from './parse-statutes';

// TAC fetcher and parser
export { fetchTACRule, fetchTACTitle, discoverTACChapters } from './fetch-tac';
export { parseTACHTML, extractTACRuleText } from './parse-tac';

// Storage and checkpointing
export {
  storeTexasStatute,
  getTexasStatute,
  listTexasStatuteSections,
  saveTexasCheckpoint,
  loadTexasCheckpoint,
  clearTexasCheckpoint,
  storeTACRule,
} from './storage';

// Chunking
export {
  chunkTexasStatute,
  chunkTexasCode,
  chunkTACRule,
  chunkTACTitle,
  getTexasChunkStats,
  type TexasChunkContext,
  type TACChunkContext,
} from './chunk';

// Pipeline orchestrator
export {
  processTexasCode,
  processTexasTACTitle,
  processTexasStatutes,
  processTexasTAC,
  processAllTexasSources,
  type TexasPipelineResult,
  type TexasBatchPipelineResult,
} from './pipeline';
```
  </action>
  <verify>
```bash
cd /Users/noahmogil/Projects/compliance-iq && pnpm -F @compliance-iq/workers exec tsc --noEmit apps/workers/src/texas/index.ts
```
TypeScript compiles without errors.
  </verify>
  <done>
Texas module index updated with all exports including pipeline functions.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Run full TypeScript check:
```bash
cd /Users/noahmogil/Projects/compliance-iq && pnpm -F @compliance-iq/workers exec tsc --noEmit
```

2. Verify worker builds:
```bash
cd /Users/noahmogil/Projects/compliance-iq && pnpm -F @compliance-iq/workers build
```

3. Test health endpoint shows new routes (if dev server running)

4. Check module exports:
```bash
grep -n "export" /Users/noahmogil/Projects/compliance-iq/apps/workers/src/texas/index.ts
```

5. Verify all texas module files exist:
```bash
ls -la /Users/noahmogil/Projects/compliance-iq/apps/workers/src/texas/
```
</verification>

<success_criteria>
- apps/workers/src/texas/pipeline.ts exports all pipeline functions
- apps/workers/src/index.ts has Texas HTTP endpoints
- Pipeline produces Pinecone vectors with:
  - jurisdiction: "TX"
  - sourceType: "tx-statute" or "tx-tac"
  - citation in Bluebook format
- Checkpoint-based resumption works for both statutes and TAC
- Worker builds successfully
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-state-data/03-06-SUMMARY.md`
</output>
