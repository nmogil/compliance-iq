---
phase: 03-state-data
plan: 04
type: execute
wave: 3
depends_on: ["03-01", "03-03"]
files_modified:
  - apps/workers/src/texas/storage.ts
  - apps/workers/src/texas/chunk.ts
autonomous: true

must_haves:
  truths:
    - "Texas statutes stored in R2 with texas/statutes/ prefix"
    - "Checkpoint system enables resumption from last processed code"
    - "Chunking produces TexasChunk objects with Bluebook citations"
  artifacts:
    - path: "apps/workers/src/texas/storage.ts"
      provides: "storeTexasStatute, saveTexasCheckpoint, loadTexasCheckpoint functions"
      exports: ["storeTexasStatute", "saveTe xasCheckpoint", "loadTexasCheckpoint", "clearTexasCheckpoint"]
      min_lines: 100
    - path: "apps/workers/src/texas/chunk.ts"
      provides: "chunkTexasStatute, chunkTexasCode functions"
      exports: ["chunkTexasStatute", "chunkTexasCode"]
      min_lines: 120
  key_links:
    - from: "apps/workers/src/texas/storage.ts"
      to: "apps/workers/src/lib/r2.ts"
      via: "storeDocument import"
      pattern: "import.*storeDocument.*r2"
    - from: "apps/workers/src/texas/chunk.ts"
      to: "apps/workers/src/lib/citations.ts"
      via: "generateTexasStatuteCitation"
      pattern: "generateTexasStatuteCitation"
---

<objective>
Create Texas Statutes storage and chunking pipeline.

Purpose: Store scraped Texas statute HTML in R2 for audit/reprocessing, and chunk sections into embedding-ready TexasChunk objects with proper Bluebook citations. Mirrors the Phase 2 CFR storage.ts and chunk.ts patterns.

Output:
- R2 storage with texas/statutes/ folder structure
- Per-code checkpoint management for pipeline resumption
- Section-level chunking with citation and metadata
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-state-data/03-RESEARCH.md
@.planning/phases/03-state-data/03-01-SUMMARY.md
@.planning/phases/03-state-data/03-03-SUMMARY.md

# Reference existing patterns
@apps/workers/src/federal/storage.ts
@apps/workers/src/federal/chunk.ts
@apps/workers/src/texas/types.ts
@apps/workers/src/lib/citations.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Texas storage with R2 and checkpoint management</name>
  <files>apps/workers/src/texas/storage.ts</files>
  <action>
Create apps/workers/src/texas/storage.ts following the federal/storage.ts pattern:

```typescript
/**
 * Texas State Data Storage Operations
 *
 * R2 storage functions for Texas Statutes and TAC data, implementing
 * organized folder structure and checkpoint management.
 *
 * Folder Structure:
 *   texas/
 *   ├── statutes/
 *   │   ├── PE/                    # Penal Code
 *   │   │   ├── chapter-30/
 *   │   │   │   └── 30.02.html
 *   │   │   └── chapter-31/
 *   │   └── HS/                    # Health & Safety Code
 *   │       └── chapter-1/
 *   ├── tac/
 *   │   ├── title-16/
 *   │   │   └── chapter-5.html
 *   │   └── title-22/
 *   └── checkpoints/
 *       ├── statutes.json
 *       └── tac.json
 */

import { storeDocument, getDocument, listDocuments, deleteDocument } from '../lib/r2';
import type { TexasCheckpoint, TexasStatuteSection } from './types';
```

Implement the following functions:

1. **storeTexasStatute(bucket: R2Bucket, section: TexasStatuteSection, html: string): Promise<void>**
   - Key pattern: `texas/statutes/{code}/chapter-{chapter}/{section}.html`
   - Store raw HTML with metadata:
     - source: 'capitol.texas.gov'
     - dataType: 'raw-statute'
     - code: section.code
     - chapter: section.chapter
     - section: section.section
     - fetchedAt: section.scrapedAt

2. **getTexasStatute(bucket: R2Bucket, code: string, chapter: string, section: string): Promise<string | null>**
   - Retrieve HTML by key
   - Return null if not found

3. **listTexasStatuteSections(bucket: R2Bucket, code: string, chapter?: string): Promise<string[]>**
   - List stored sections for a code (optionally filtered by chapter)
   - Return array of section identifiers

4. **saveTexasCheckpoint(bucket: R2Bucket, checkpoint: TexasCheckpoint): Promise<void>**
   - Key pattern: `texas/checkpoints/{sourceType}.json`
   - Store checkpoint JSON with metadata

5. **loadTexasCheckpoint(bucket: R2Bucket, sourceType: 'statute' | 'tac'): Promise<TexasCheckpoint | null>**
   - Load checkpoint for source type
   - Return null if no checkpoint exists (fresh start)
   - Handle corrupted checkpoint gracefully

6. **clearTexasCheckpoint(bucket: R2Bucket, sourceType: 'statute' | 'tac'): Promise<void>**
   - Delete checkpoint after successful completion

7. **storeTACRule(bucket: R2Bucket, rule: TACRule, html: string): Promise<void>**
   - Key pattern: `texas/tac/title-{title}/chapter-{chapter}/{section}.html`
   - Similar to storeTexasStatute but for TAC

Add comprehensive JSDoc comments and export all functions.
  </action>
  <verify>
```bash
cd /Users/noahmogil/Projects/compliance-iq && pnpm -F @compliance-iq/workers exec tsc --noEmit apps/workers/src/texas/storage.ts
```
TypeScript compiles without errors.
  </verify>
  <done>
Storage module created with:
- R2 storage for Texas statutes and TAC
- Organized folder structure by code/title
- Per-source-type checkpoint management
- Functions for store, get, list, checkpoint operations
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Texas Statutes chunking pipeline</name>
  <files>apps/workers/src/texas/chunk.ts</files>
  <action>
Create apps/workers/src/texas/chunk.ts following the federal/chunk.ts pattern:

```typescript
/**
 * Texas State Data Chunking Pipeline
 *
 * Structure-aware chunking for Texas Statutes and TAC text.
 * Preserves legal hierarchy, generates Bluebook citations, and splits
 * oversized sections at subsection boundaries with overlap.
 */

import type { TexasStatuteSection, TexasChunk, TexasCodeConfig, TACRule } from './types';
import { countTokens } from '../lib/tokens';
import {
  generateTexasStatuteCitation,
  generateStatuteUrl,
  generateTexasChunkId,
  generateTexasSourceId,
  generateTexasHierarchy,
} from '../lib/citations';
```

**Constants (same as CFR):**
```typescript
const MAX_CHUNK_TOKENS = 1500;
const OVERLAP_RATIO = 0.15;
```

Implement the following functions:

1. **ChunkContext interface:**
```typescript
export interface TexasChunkContext {
  code: string;
  codeName: string;
  chapter: string;
  category?: string;
}
```

2. **chunkTexasStatute(section: TexasStatuteSection, context: TexasChunkContext): TexasChunk[]**
   - Count tokens in section.text
   - If ≤ MAX_CHUNK_TOKENS: return single chunk
   - If > MAX_CHUNK_TOKENS: split at subsection boundaries
   - Generate citation using generateTexasStatuteCitation
   - Generate URL using generateStatuteUrl
   - Generate hierarchy using generateTexasHierarchy
   - Set sourceType: 'tx-statute'
   - Include chunkIndex and totalChunks

   ```typescript
   export function chunkTexasStatute(
     section: TexasStatuteSection,
     context: TexasChunkContext
   ): TexasChunk[] {
     const tokenCount = countTokens(section.text);

     if (tokenCount <= MAX_CHUNK_TOKENS) {
       return [{
         chunkId: generateTexasChunkId('statute', context.code, context.chapter, section.section, 0),
         sourceId: generateTexasSourceId('statute', context.code),
         sourceType: 'tx-statute',
         text: section.text,
         citation: generateTexasStatuteCitation(context.code, section.section),
         url: generateStatuteUrl(context.code, section.section),
         code: context.code,
         chapter: context.chapter,
         section: section.section,
         hierarchy: generateTexasHierarchy('statute', context.code, context.codeName, context.chapter, section.section),
         category: context.category,
         chunkIndex: 0,
         totalChunks: 1,
       }];
     }

     // Split at subsection boundaries
     return splitStatuteSection(section, context);
   }
   ```

3. **splitStatuteSection(section: TexasStatuteSection, context: TexasChunkContext): TexasChunk[]**
   - Parse subsections from section.text (same pattern as CFR)
   - Create chunk per subsection
   - If subsection still too large, split with overlap

4. **splitWithOverlap(text: string, maxTokens: number, overlapRatio: number): string[]**
   - Reuse/adapt from federal/chunk.ts
   - Split at paragraph boundaries
   - Add 15% overlap for context preservation

5. **chunkTexasCode(sections: TexasStatuteSection[], codeConfig: TexasCodeConfig): TexasChunk[]**
   - Batch chunking for entire code
   - Returns flat array of all chunks
   - Logs statistics (total chunks, avg tokens, oversized sections)

6. **getTexasChunkStats(chunks: TexasChunk[]): ChunkStats**
   - Calculate chunk statistics (reuse ChunkStats interface from CFR)
   - Total chunks, avg tokens, max tokens, sections chunked

**Validation:**
- Throw error if any chunk exceeds MAX_CHUNK_TOKENS after splitting
- Log warnings for sections that require splitting

Export all public functions.
  </action>
  <verify>
```bash
cd /Users/noahmogil/Projects/compliance-iq && pnpm -F @compliance-iq/workers exec tsc --noEmit apps/workers/src/texas/chunk.ts
```
TypeScript compiles without errors.
  </verify>
  <done>
Chunking module created with:
- Section-level chunking respecting legal structure
- Subsection boundary splitting for oversized sections
- 15% overlap for context preservation
- Bluebook citation generation
- Statistics tracking
  </done>
</task>

<task type="auto">
  <name>Task 3: Update texas/index.ts with storage and chunk exports</name>
  <files>apps/workers/src/texas/index.ts</files>
  <action>
Update apps/workers/src/texas/index.ts to export the new storage and chunking functions:

```typescript
/**
 * Texas State Data Pipeline Module
 *
 * Provides scraping, parsing, storage, and processing for Texas Statutes
 * and Texas Administrative Code (TAC).
 */

// Types
export * from './types';

// Statute fetcher and parser
export { fetchTexasStatute, fetchTexasCode, discoverCodeChapters } from './fetch-statutes';
export { parseStatuteHTML, extractSectionText } from './parse-statutes';

// Storage and checkpointing
export {
  storeTexasStatute,
  getTexasStatute,
  listTexasStatuteSections,
  saveTexasCheckpoint,
  loadTexasCheckpoint,
  clearTexasCheckpoint,
  storeTACRule,
} from './storage';

// Chunking
export {
  chunkTexasStatute,
  chunkTexasCode,
  getTexasChunkStats,
  type TexasChunkContext,
} from './chunk';

// Future: TAC fetcher and parser (03-05)
// export { fetchTACRule, fetchTACTitle } from './fetch-tac';
// export { parseTACHTML } from './parse-tac';

// Future: Pipeline orchestrator (03-06)
// export { processTexasStatutes, processAllTexasSources } from './pipeline';
```
  </action>
  <verify>
```bash
cd /Users/noahmogil/Projects/compliance-iq && pnpm -F @compliance-iq/workers exec tsc --noEmit apps/workers/src/texas/index.ts
```
TypeScript compiles without errors.
  </verify>
  <done>
Texas module index updated with storage and chunking exports.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Run full TypeScript check:
```bash
cd /Users/noahmogil/Projects/compliance-iq && pnpm -F @compliance-iq/workers exec tsc --noEmit
```

2. Verify module structure:
```bash
ls -la /Users/noahmogil/Projects/compliance-iq/apps/workers/src/texas/
```

3. Check exports:
```bash
grep -n "export" /Users/noahmogil/Projects/compliance-iq/apps/workers/src/texas/index.ts
```
</verification>

<success_criteria>
- apps/workers/src/texas/storage.ts exports storage and checkpoint functions
- apps/workers/src/texas/chunk.ts exports chunking functions
- R2 folder structure: texas/statutes/{code}/chapter-{chapter}/
- Checkpoint structure: texas/checkpoints/statutes.json
- Chunks have Bluebook citations and tx-statute sourceType
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-state-data/03-04-SUMMARY.md`
</output>
