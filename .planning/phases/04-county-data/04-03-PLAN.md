---
phase: 04-county-data
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - apps/workers/src/counties/adapters/elaws.ts
  - apps/workers/src/counties/adapters/amlegal.ts
  - apps/workers/src/counties/adapters/index.ts
autonomous: true

must_haves:
  truths:
    - "eLaws adapter can fetch Dallas County ordinances"
    - "American Legal adapter handles AmLegal platform counties (if any exist in target 10)"
    - "Adapter factory returns correct adapter for each county platform"
  artifacts:
    - path: "apps/workers/src/counties/adapters/elaws.ts"
      provides: "eLaws platform scraper for Dallas County"
      exports: ["ElawsAdapter"]
    - path: "apps/workers/src/counties/adapters/amlegal.ts"
      provides: "American Legal Publishing scraper"
      exports: ["AmlegalAdapter"]
    - path: "apps/workers/src/counties/adapters/index.ts"
      provides: "Adapter factory and exports"
      exports: ["getAdapterForCounty", "MunicodeAdapter", "ElawsAdapter", "AmlegalAdapter"]
  key_links:
    - from: "apps/workers/src/counties/adapters/index.ts"
      to: "apps/workers/src/counties/sources.ts"
      via: "CountySourceConfig lookup"
      pattern: "import.*from.*sources"
---

<objective>
Create eLaws and American Legal adapters for remaining county platforms, plus adapter factory.

Purpose: Complete the adapter infrastructure to support all platform types found during county research, enabling the fetch orchestrator to scrape any enabled county.

Output:
- eLaws adapter for Dallas County (confirmed source)
- American Legal adapter (for any counties using AmLegal)
- Adapter factory that returns the correct adapter for each county
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-county-data/04-RESEARCH.md
@.planning/phases/04-county-data/04-01-SUMMARY.md
@apps/workers/src/counties/adapters/base.ts
@apps/workers/src/counties/adapters/municode.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create eLaws adapter</name>
  <files>apps/workers/src/counties/adapters/elaws.ts</files>
  <action>
Create adapter for eLaws platform (used by Dallas County).

First, inspect http://dallascounty-tx.elaws.us/code/coor to understand the HTML structure:
- eLaws typically uses frames/iframes for navigation
- May require constructing URLs from table of contents
- Check for AJAX loading vs static HTML

Implement adapter:

```typescript
import * as cheerio from 'cheerio';
import { CountyAdapterBase } from './base';
import type { CountyOrdinance, CountySourceConfig } from '../types';

/**
 * eLaws platform adapter
 *
 * Used by Dallas County. eLaws platform typically has:
 * - Table of contents on left side
 * - Content loads in main frame
 * - URLs may include section anchors
 *
 * Platform URL pattern: http://{county}-tx.elaws.us/code/coor
 */
export class ElawsAdapter extends CountyAdapterBase {
  county: string;
  fipsCode: string;
  baseUrl: string;
  platform: CountySourceConfig['platform'] = 'elaws';

  constructor(config: { county: string; fipsCode: string; baseUrl: string }) {
    super();
    this.county = config.county;
    this.fipsCode = config.fipsCode;
    this.baseUrl = config.baseUrl;
    // eLaws may be slower - increase rate limit
    this.rateLimit = 1000;
  }

  protected validateStructure($: cheerio.CheerioAPI): boolean {
    // Validate eLaws structure
    // Adjust based on actual inspection
    return (
      $('.toc-item').length > 0 ||
      $('frame').length > 0 ||
      $('a[href*="coor"]').length > 0 ||
      $('table').length > 0
    );
  }

  async *fetchOrdinances(): AsyncGenerator<CountyOrdinance, void, unknown> {
    console.log(`[ElawsAdapter] Starting fetch for ${this.county} County`);

    const $ = await this.loadPage(this.baseUrl);

    // eLaws typically has table of contents with links to sections
    const sectionLinks = this.extractSectionLinks($);

    for (const link of sectionLinks) {
      console.log(`[ElawsAdapter] Processing: ${link.title}`);

      await this.sleep(this.rateLimit);

      try {
        const section$ = await this.loadPage(link.url);
        const ordinance = this.parseSection(section$, link);

        if (ordinance) {
          yield ordinance;
        }
      } catch (error) {
        console.error(`[ElawsAdapter] Failed to fetch ${link.url}:`, error);
        // Continue with next section
      }
    }
  }

  private extractSectionLinks($: cheerio.CheerioAPI): Array<{
    url: string;
    title: string;
    chapter: string;
    section: string;
  }> {
    const links: Array<{
      url: string;
      title: string;
      chapter: string;
      section: string;
    }> = [];

    // Try multiple selector strategies for eLaws
    const selectors = [
      '.toc-item a',
      'a[href*="sec"]',
      'table a',
      '#toc a'
    ];

    for (const selector of selectors) {
      $(selector).each((_, el) => {
        const href = $(el).attr('href');
        const title = $(el).text().trim();

        if (href && title && title.length > 0) {
          const url = href.startsWith('http')
            ? href
            : `${this.baseUrl.replace(/\/[^/]*$/, '')}/${href}`;

          // Parse chapter/section from title
          // Pattern: "Chapter 1 - Title" or "Sec. 1.02 - Title"
          const chapterMatch = title.match(/Chapter\s+(\d+)/i);
          const sectionMatch = title.match(/Sec(?:tion)?\.?\s*([\d.]+)/i);

          links.push({
            url,
            title,
            chapter: chapterMatch ? chapterMatch[1] : '0',
            section: sectionMatch ? sectionMatch[1] : '0'
          });
        }
      });

      if (links.length > 0) break;
    }

    return links;
  }

  private parseSection(
    $: cheerio.CheerioAPI,
    link: { chapter: string; section: string; url: string }
  ): CountyOrdinance | null {
    // Extract heading and text from section page
    const heading = $('h1, h2, .section-title').first().text().trim();
    const text = $('.section-text, .content, main p').text().trim();

    if (!text) {
      return null;
    }

    return {
      county: this.county,
      fipsCode: this.fipsCode,
      chapter: link.chapter,
      section: link.section,
      heading: heading || `Section ${link.section}`,
      text,
      sourceUrl: link.url,
      scrapedAt: new Date().toISOString()
    };
  }
}
```

Selectors will need refinement based on actual Dallas County eLaws HTML structure.
  </action>
  <verify>TypeScript compiles: `pnpm -F @compliance-iq/workers exec tsc --noEmit`</verify>
  <done>ElawsAdapter class implements fetchOrdinances for Dallas County pattern</done>
</task>

<task type="auto">
  <name>Task 2: Create American Legal adapter</name>
  <files>apps/workers/src/counties/adapters/amlegal.ts</files>
  <action>
Create adapter for American Legal Publishing platform.

IMPORTANT: Per research, American Legal's robots.txt:
- Blocks AI training bots (ClaudeBot, GPTBot)
- Has 5-second crawl delay
- Includes "Content-Signal: search=yes,ai-train=no"

Implement adapter with compliance:

```typescript
import * as cheerio from 'cheerio';
import { CountyAdapterBase } from './base';
import type { CountyOrdinance, CountySourceConfig } from '../types';

/**
 * American Legal Publishing adapter
 *
 * Platform: codelibrary.amlegal.com
 *
 * COMPLIANCE REQUIREMENTS:
 * - 5-second crawl delay (robots.txt)
 * - User-Agent not in blocked list
 * - Content for search only, not AI training
 *
 * Platform URL pattern: https://codelibrary.amlegal.com/codes/{jurisdiction}/latest/overview
 */
export class AmlegalAdapter extends CountyAdapterBase {
  county: string;
  fipsCode: string;
  baseUrl: string;
  platform: CountySourceConfig['platform'] = 'amlegal';

  constructor(config: { county: string; fipsCode: string; baseUrl: string }) {
    super();
    this.county = config.county;
    this.fipsCode = config.fipsCode;
    this.baseUrl = config.baseUrl;

    // American Legal requires 5-second delay per robots.txt
    this.rateLimit = 5000;

    // Use compliant User-Agent (not in blocked list)
    this.userAgent = 'ComplianceIQ/1.0 Legal Research (+https://compliance-iq.com)';
  }

  protected validateStructure($: cheerio.CheerioAPI): boolean {
    // Validate AmLegal structure
    return (
      $('.code-section').length > 0 ||
      $('.toc-node').length > 0 ||
      $('[data-node-id]').length > 0
    );
  }

  async *fetchOrdinances(): AsyncGenerator<CountyOrdinance, void, unknown> {
    console.log(`[AmlegalAdapter] Starting fetch for ${this.county} County`);
    console.log(`[AmlegalAdapter] Using 5-second delay per robots.txt`);

    const $ = await this.loadPage(this.baseUrl);

    // AmLegal uses tree navigation with node IDs
    const nodes = this.extractTocNodes($);

    for (const node of nodes) {
      console.log(`[AmlegalAdapter] Processing: ${node.title} (5s delay)`);

      await this.sleep(this.rateLimit);

      try {
        const section$ = await this.loadPage(node.url);
        const ordinance = this.parseNode(section$, node);

        if (ordinance) {
          yield ordinance;
        }
      } catch (error) {
        console.error(`[AmlegalAdapter] Failed to fetch ${node.url}:`, error);
      }
    }
  }

  private extractTocNodes($: cheerio.CheerioAPI): Array<{
    url: string;
    title: string;
    nodeId: string;
    chapter: string;
    section: string;
  }> {
    const nodes: Array<{
      url: string;
      title: string;
      nodeId: string;
      chapter: string;
      section: string;
    }> = [];

    // AmLegal uses data attributes for node identification
    $('[data-node-id]').each((_, el) => {
      const nodeId = $(el).attr('data-node-id') || '';
      const title = $(el).text().trim();
      const href = $(el).attr('href') || '';

      if (nodeId && title) {
        const url = href.startsWith('http')
          ? href
          : `${this.baseUrl.replace(/\/overview$/, '')}/${href}`;

        // Parse chapter/section from node ID or title
        const chapterMatch = title.match(/Chapter\s+(\d+)/i) || nodeId.match(/CHAPTER_(\d+)/i);
        const sectionMatch = title.match(/Sec(?:tion)?\.?\s*([\d.]+)/i);

        nodes.push({
          url,
          title,
          nodeId,
          chapter: chapterMatch ? chapterMatch[1] : '0',
          section: sectionMatch ? sectionMatch[1] : '0'
        });
      }
    });

    return nodes;
  }

  private parseNode(
    $: cheerio.CheerioAPI,
    node: { chapter: string; section: string; url: string }
  ): CountyOrdinance | null {
    const heading = $('.section-heading, h1, h2').first().text().trim();
    const text = $('.section-content, .code-text, main').text().trim();

    if (!text) {
      return null;
    }

    return {
      county: this.county,
      fipsCode: this.fipsCode,
      chapter: node.chapter,
      section: node.section,
      heading: heading || `Section ${node.section}`,
      text,
      sourceUrl: node.url,
      scrapedAt: new Date().toISOString()
    };
  }
}
```
  </action>
  <verify>TypeScript compiles and adapter uses 5-second rate limit</verify>
  <done>AmlegalAdapter implements robots.txt compliance with 5-second delay</done>
</task>

<task type="auto">
  <name>Task 3: Create adapter factory and index</name>
  <files>apps/workers/src/counties/adapters/index.ts</files>
  <action>
Create adapter factory that returns the correct adapter for each county based on its platform type.

```typescript
import { MunicodeAdapter } from './municode';
import { ElawsAdapter } from './elaws';
import { AmlegalAdapter } from './amlegal';
import { CountyAdapterBase } from './base';
import { TARGET_COUNTIES, getCountyByName } from '../sources';
import type { CountySourceConfig, CountyAdapter } from '../types';

// Re-export adapters
export { CountyAdapterBase, loadCheerioPage } from './base';
export { MunicodeAdapter } from './municode';
export { ElawsAdapter } from './elaws';
export { AmlegalAdapter } from './amlegal';

/**
 * Get the appropriate adapter for a county based on its platform type
 *
 * @param countyName County name (e.g., "Harris", "Dallas")
 * @returns Adapter instance or null if county is not enabled or has no adapter
 *
 * @example
 * const adapter = getAdapterForCounty('Harris');
 * if (adapter) {
 *   for await (const ordinance of adapter.fetchOrdinances()) {
 *     console.log(ordinance.heading);
 *   }
 * }
 */
export function getAdapterForCounty(countyName: string): CountyAdapter | null {
  const config = getCountyByName(countyName);

  if (!config) {
    console.error(`[AdapterFactory] County not found: ${countyName}`);
    return null;
  }

  if (!config.enabled) {
    console.warn(`[AdapterFactory] County disabled: ${countyName} (${config.skipReason})`);
    return null;
  }

  if (!config.baseUrl || !config.platform) {
    console.error(`[AdapterFactory] County missing baseUrl or platform: ${countyName}`);
    return null;
  }

  const adapterConfig = {
    county: config.name,
    fipsCode: config.fipsCode,
    baseUrl: config.baseUrl
  };

  switch (config.platform) {
    case 'municode-online':
      return new MunicodeAdapter(adapterConfig);

    case 'elaws':
      return new ElawsAdapter(adapterConfig);

    case 'amlegal':
      return new AmlegalAdapter(adapterConfig);

    case 'court-orders':
      // Court order scraper not yet implemented
      console.warn(`[AdapterFactory] Court orders adapter not implemented: ${countyName}`);
      return null;

    case 'custom':
      // Custom adapter would need per-county implementation
      console.warn(`[AdapterFactory] Custom adapter not implemented: ${countyName}`);
      return null;

    default:
      console.error(`[AdapterFactory] Unknown platform: ${config.platform}`);
      return null;
  }
}

/**
 * Get adapters for all enabled counties
 *
 * @returns Array of adapter instances for all enabled counties
 */
export function getAdaptersForEnabledCounties(): CountyAdapter[] {
  const adapters: CountyAdapter[] = [];

  for (const config of TARGET_COUNTIES) {
    if (config.enabled) {
      const adapter = getAdapterForCounty(config.name);
      if (adapter) {
        adapters.push(adapter);
      }
    }
  }

  return adapters;
}

/**
 * Validate source availability for all enabled counties
 *
 * @returns Validation results for each county
 */
export async function validateAllCountySources(): Promise<{
  valid: string[];
  invalid: Array<{ county: string; error: string }>;
}> {
  const valid: string[] = [];
  const invalid: Array<{ county: string; error: string }> = [];

  const adapters = getAdaptersForEnabledCounties();

  for (const adapter of adapters) {
    console.log(`[Validation] Checking ${adapter.county} County...`);

    const result = await adapter.validateSource();

    if (result.accessible) {
      valid.push(adapter.county);
    } else {
      invalid.push({ county: adapter.county, error: result.error || 'Unknown error' });
    }

    // Rate limit between validations
    await new Promise(resolve => setTimeout(resolve, 1000));
  }

  return { valid, invalid };
}
```
  </action>
  <verify>TypeScript compiles and all exports are available</verify>
  <done>getAdapterForCounty factory returns correct adapter for each platform type</done>
</task>

</tasks>

<verification>
1. ElawsAdapter implements Dallas County scraping pattern
2. AmlegalAdapter respects 5-second rate limit from robots.txt
3. getAdapterForCounty returns correct adapter for each platform type
4. All code compiles: `pnpm -F @compliance-iq/workers exec tsc --noEmit`
</verification>

<success_criteria>
- ElawsAdapter exported and handles eLaws platform
- AmlegalAdapter exported with 5-second rate limit compliance
- getAdapterForCounty factory works for all platform types
- getAdaptersForEnabledCounties returns adapters for enabled counties
- No TypeScript compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-county-data/04-03-SUMMARY.md`
</output>
