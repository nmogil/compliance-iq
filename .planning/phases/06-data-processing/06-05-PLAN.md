---
phase: 06-data-processing
plan: 05
type: execute
wave: 2
depends_on: ["06-01", "06-02", "06-03"]
files_modified:
  - apps/workers/src/validation/quality-reporter.ts
autonomous: true

must_haves:
  truths:
    - "Quality reporter generates comprehensive data quality reports"
    - "Reporter queries Pinecone metadata for analysis"
    - "Reports include token distribution and metadata completeness"
  artifacts:
    - path: "apps/workers/src/validation/quality-reporter.ts"
      provides: "Data quality report generation"
      exports: ["generateQualityReport", "formatQualityReportMarkdown", "generateFullValidationReport"]
  key_links:
    - from: "apps/workers/src/validation/quality-reporter.ts"
      to: "apps/workers/src/validation/token-analyzer.ts"
      via: "analyzeTokenDistribution import"
      pattern: "import.*analyzeTokenDistribution"
    - from: "apps/workers/src/validation/quality-reporter.ts"
      to: "apps/workers/src/validation/metadata-validator.ts"
      via: "metadata validation imports"
      pattern: "import.*getMetadataCompleteness"
---

<objective>
Build quality reporter that generates comprehensive data quality reports by jurisdiction.

Purpose: Aggregate token analysis and metadata validation into actionable quality reports. This validates DATA-07/08/09 by measuring chunk quality, metadata completeness, and citation coverage.

Output: Functions to generate quality reports and format them as JSON or markdown.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-data-processing/06-01-PLAN.md
@.planning/phases/06-data-processing/06-02-PLAN.md
@.planning/phases/06-data-processing/06-03-PLAN.md
@apps/workers/src/pinecone.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create quality reporter</name>
  <files>apps/workers/src/validation/quality-reporter.ts</files>
  <action>
Create quality report generation utilities:

1. **Imports:**
   - analyzeTokenDistribution from './token-analyzer'
   - getMetadataCompleteness, checkCitationCoverage, validateMetadataArray from './metadata-validator'
   - DataQualityReport, ValidationResult from './types'
   - ChunkMetadata, queryChunks from '../pinecone'

2. **fetchChunksForJurisdiction(index: Index, sourceType: string, jurisdiction?: string, limit?: number): Promise<ChunkMetadata[]>**
   - Query Pinecone with filter by sourceType (and optionally jurisdiction)
   - Use dummy query vector (zeros) with topK=limit (default 1000)
   - Extract metadata from results
   - Note: This is a sample, not all chunks (Pinecone doesn't allow bulk export)

3. **generateQualityReport(chunks: ChunkMetadata[], jurisdiction: string, sourceType: string): DataQualityReport**
   - Extract text array for token analysis
   - Call analyzeTokenDistribution on texts
   - Call getMetadataCompleteness on metadata array
   - Call checkCitationCoverage
   - Call validateMetadataArray to find issues
   - Assemble into DataQualityReport

4. **generateFullValidationReport(index: Index): Promise<ValidationResult>**
   - Fetch sample chunks for each sourceType (federal, state, county, municipal)
   - Generate quality report for each
   - Aggregate into ValidationResult with summary
   - Summary: totalChunks (across samples), avgTokens, coveragePercent, issuesCount

5. **formatQualityReportMarkdown(report: DataQualityReport): string**
   - Format single jurisdiction report as markdown
   - Include sections: Summary, Token Distribution, Metadata, Issues
   - Use tables for distribution stats

6. **formatValidationResultMarkdown(result: ValidationResult): string**
   - Format full validation result as markdown
   - Include executive summary at top
   - List quality reports for each sourceType
   - Highlight critical issues

Add logging for report generation progress.
Add JSDoc explaining sampling approach (Pinecone doesn't export all vectors).
  </action>
  <verify>Run: cd apps/workers && pnpm exec tsc --noEmit src/validation/quality-reporter.ts</verify>
  <done>Quality reporter compiles with all functions exported</done>
</task>

<task type="auto">
  <name>Task 2: Update module exports</name>
  <files>apps/workers/src/validation/index.ts</files>
  <action>
Update module index to export quality reporter:

```typescript
/**
 * Data Processing Validation Module
 *
 * Provides types and utilities for validating the end-to-end
 * data processing pipeline across all jurisdiction types.
 *
 * @module validation
 */

export * from './types';
export * from './token-analyzer';
export * from './metadata-validator';
export * from './coverage-checker';
export * from './quality-reporter';
```
  </action>
  <verify>Run: cd apps/workers && pnpm exec tsc --noEmit src/validation/index.ts</verify>
  <done>Quality reporter exports accessible from validation module</done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes
2. All analyzer/validator imports resolve
3. Quality reports conform to DataQualityReport type
4. Markdown formatting produces readable output
</verification>

<success_criteria>
- generateQualityReport produces complete DataQualityReport
- generateFullValidationReport aggregates across source types
- formatQualityReportMarkdown produces human-readable output
- Sample-based approach documented in JSDoc
</success_criteria>

<output>
After completion, create `.planning/phases/06-data-processing/06-05-SUMMARY.md`
</output>
