---
phase: 06-data-processing
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/workers/src/validation/metadata-validator.ts
autonomous: true

must_haves:
  truths:
    - "Metadata validator checks completeness of required fields"
    - "Validator identifies chunks with missing citations"
    - "Validator calculates completeness percentages per field"
  artifacts:
    - path: "apps/workers/src/validation/metadata-validator.ts"
      provides: "Metadata completeness validation"
      exports: ["validateMetadata", "getMetadataCompleteness", "checkCitationCoverage"]
  key_links:
    - from: "apps/workers/src/validation/metadata-validator.ts"
      to: "apps/workers/src/pinecone.ts"
      via: "ChunkMetadata type import"
      pattern: "import.*ChunkMetadata.*from.*pinecone"
---

<objective>
Build metadata validator to ensure chunk metadata completeness and citation coverage.

Purpose: Validate that chunks have required metadata (citation, jurisdiction, sourceType) and track optional field completeness. This validates DATA-09 (Pinecone stores vectors with jurisdiction/activity/citation metadata).

Output: Functions to validate metadata fields, calculate completeness percentages, and identify problematic chunks.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/workers/src/pinecone.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create metadata validator</name>
  <files>apps/workers/src/validation/metadata-validator.ts</files>
  <action>
Create metadata validation utilities:

1. **validateMetadata(metadata: ChunkMetadata): MetadataValidationResult**
   - MetadataValidationResult: { valid: boolean, missingRequired: string[], warnings: string[] }
   - Required fields (must be non-empty): chunkId, sourceId, sourceType, jurisdiction, text, citation, indexedAt
   - Optional but recommended: title, category, lastUpdated
   - Add warnings for empty optional fields (not errors)
   - Return valid: true only if all required fields present

2. **getMetadataCompleteness(metadataArray: ChunkMetadata[]): MetadataCompleteness**
   - Count how many chunks have each optional field
   - Return: { hasCategory: number, hasTitle: number, hasLastUpdated: number }
   - Calculate as raw counts (caller can convert to percentage)

3. **checkCitationCoverage(metadataArray: ChunkMetadata[]): CitationCoverageResult**
   - CitationCoverageResult: { totalChunks: number, withCitation: number, coveragePercent: number, missingCitations: string[] }
   - missingCitations is array of chunkIds without citations
   - A valid citation is non-empty string

4. **validateMetadataArray(metadataArray: ChunkMetadata[]): MetadataArrayValidation**
   - MetadataArrayValidation: { totalChunks: number, validChunks: number, invalidChunks: Array<{chunkId: string, issues: string[]}> }
   - Validate each chunk and collect all issues
   - Return summary with list of problematic chunks

5. **checkSourceTypeDistribution(metadataArray: ChunkMetadata[]): SourceTypeDistribution**
   - SourceTypeDistribution: { federal: number, state: number, county: number, municipal: number }
   - Count chunks by sourceType field
   - Useful for verifying expected distribution

Import ChunkMetadata from '../pinecone'.
Add JSDoc documentation explaining each validation check.
  </action>
  <verify>Run: cd apps/workers && pnpm exec tsc --noEmit src/validation/metadata-validator.ts</verify>
  <done>Metadata validator compiles with all 5 functions exported</done>
</task>

<task type="auto">
  <name>Task 2: Update module exports</name>
  <files>apps/workers/src/validation/index.ts</files>
  <action>
Update module index to export metadata validator:

```typescript
/**
 * Data Processing Validation Module
 *
 * Provides types and utilities for validating the end-to-end
 * data processing pipeline across all jurisdiction types.
 *
 * @module validation
 */

export * from './types';
export * from './token-analyzer';
export * from './metadata-validator';
```
  </action>
  <verify>Run: cd apps/workers && pnpm exec tsc --noEmit src/validation/index.ts</verify>
  <done>Metadata validator exports accessible from validation module</done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes
2. ChunkMetadata properly imported from pinecone.ts
3. All required metadata fields are checked
4. Citation coverage calculation is accurate (percentage 0-100)
</verification>

<success_criteria>
- validateMetadata correctly identifies missing required fields
- getMetadataCompleteness counts optional field presence
- checkCitationCoverage returns accurate percentage
- validateMetadataArray aggregates all validation issues
- Module exports updated with metadata-validator
</success_criteria>

<output>
After completion, create `.planning/phases/06-data-processing/06-03-SUMMARY.md`
</output>
