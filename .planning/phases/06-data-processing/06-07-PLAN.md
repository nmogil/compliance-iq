---
phase: 06-data-processing
plan: 07
type: execute
wave: 3
depends_on: ["06-01"]
files_modified:
  - docs/DATA-PROCESSING.md
autonomous: true

must_haves:
  truths:
    - "Documentation describes chunking strategy for each source type"
    - "Metadata schema is fully documented with field descriptions"
    - "R2 folder structure documented with examples"
  artifacts:
    - path: "docs/DATA-PROCESSING.md"
      provides: "Comprehensive data pipeline documentation"
      min_lines: 200
  key_links:
    - from: "docs/DATA-PROCESSING.md"
      to: "apps/workers/src/pinecone.ts"
      via: "ChunkMetadata schema documentation"
      pattern: "ChunkMetadata"
---

<objective>
Document the data processing pipeline including chunking strategies, metadata schema, and R2 folder structure.

Purpose: Create comprehensive documentation that formalizes the patterns established in Phases 2-5. This documentation serves as a reference for future phases and maintenance.

Output: docs/DATA-PROCESSING.md with complete pipeline documentation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/workers/src/pinecone.ts
@apps/workers/src/federal/chunk.ts
@apps/workers/src/texas/chunk.ts
@apps/workers/src/counties/chunk.ts
@apps/workers/src/municipal/chunk.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create data processing documentation</name>
  <files>docs/DATA-PROCESSING.md</files>
  <action>
Create comprehensive documentation:

# Data Processing Pipeline

## Overview
- Purpose: Transform regulatory documents into searchable vector embeddings
- Pipeline stages: Fetch -> Store -> Chunk -> Embed -> Index
- Source types: Federal, State, County, Municipal

## Chunking Strategy

### General Principles
- Maximum 1500 tokens per chunk (well under 8191 embedding limit)
- 15% overlap for cross-reference context preservation
- Three-tier fallback: whole section -> subsection split -> paragraph split
- Structure-aware chunking respects legal hierarchy

### Federal (CFR)
- Source: eCFR API (XML)
- Granularity: Section-level (21 CFR 117.5)
- Splitting: Subsections (a), (b), (c) then paragraphs

### State (Texas Statutes & TAC)
- Source: capitol.texas.gov (HTML) and SOS TAC (HTML)
- Granularity: Section-level for statutes, rule-level for TAC
- Splitting: Same as federal - subsections then paragraphs

### County (Ordinances)
- Source: Municode/eLaws (HTML)
- Granularity: Section-level
- Splitting: Paragraph-based (less structured than federal)

### Municipal (City Codes)
- Source: Municode/American Legal via Firecrawl (Markdown)
- Granularity: Section-level
- Splitting: Paragraph-based with subsection detection

## Metadata Schema (Pinecone)

Document all fields from ChunkMetadata:

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| chunkId | string | Yes | Unique identifier (e.g., cfr-21-117-5-0) |
| sourceId | string | Yes | Source document ID |
| sourceType | enum | Yes | 'federal' | 'state' | 'county' | 'municipal' |
| jurisdiction | string | Yes | 'US', 'TX', 'TX-48201', 'TX-houston' |
| text | string | Yes | Full chunk text |
| citation | string | Yes | Bluebook citation |
| title | string | No | Section title/heading |
| chunkIndex | number | Yes | Position in document (0-indexed) |
| totalChunks | number | Yes | Total chunks in document |
| category | string | No | Activity tag (food-safety, building-codes) |
| indexedAt | string | Yes | ISO timestamp |
| lastUpdated | string | No | Source last updated |

## R2 Storage Structure

Document folder hierarchy:

```
/
├── federal/
│   └── cfr/
│       └── title-{N}/
│           └── part-{N}.xml
├── texas/
│   ├── statutes/
│   │   └── {code}/
│   │       └── chapter-{N}/
│   │           └── {section}.html
│   └── tac/
│       └── title-{N}/
│           └── chapter-{N}/
│               └── {section}.html
├── counties/
│   └── {fipsCode}/
│       └── chapter-{name}/
│           └── {section}.html
│   └── checkpoints/
│       └── county.json
└── municipal/
    └── {cityId}/
        ├── chapter-{N}/
        │   └── {section}.json
        └── raw/
            └── page.md
    └── checkpoints/
        └── municipal.json
```

## Embedding Pipeline

### Configuration
- Model: text-embedding-3-large (3072 dimensions)
- Batch size: 64 chunks
- Batch delay: 100ms
- Retry: Exponential backoff (1s, 2s, 4s, 8s)

### Token Validation
- Pre-validate all chunks before API call
- Reject chunks > 8191 tokens (hard limit)
- Target chunks <= 1500 tokens (soft limit)

## Pinecone Index

### Configuration
- Index name: compliance-embeddings
- Dimensions: 3072
- Metric: cosine
- Region: aws/us-east-1

### Upsert Batching
- Batch size: 100 vectors
- Includes full metadata for filtering

## Data Freshness

### Convex Tracking
- jurisdictions table tracks lastScrapedAt per jurisdiction
- status: 'pending' | 'active' | 'error'
- vectorCount for capacity monitoring

### Re-scraping Strategy
- Manual trigger via HTTP endpoints
- No automatic freshness detection (no source change APIs)
- Recommended: Monthly re-scrape for active sources

## Quality Metrics

### Validation Types (Phase 6)
- TokenDistribution: min, max, avg, percentiles
- MetadataCompleteness: optional field coverage
- CoverageReport: expected vs indexed sources
- DataQualityReport: per-jurisdiction metrics

### Targets
- Citation coverage: 100%
- Average tokens per chunk: 800-1200
- P95 tokens: < 1400
  </action>
  <verify>Verify file exists and has content: wc -l docs/DATA-PROCESSING.md</verify>
  <done>Documentation file created with all sections</done>
</task>

<task type="auto">
  <name>Task 2: Ensure docs directory exists</name>
  <files>docs/.gitkeep</files>
  <action>
Create docs directory if it doesn't exist. The Write tool will handle this automatically when creating DATA-PROCESSING.md, but verify the directory is tracked:

If docs/ doesn't exist, it will be created with DATA-PROCESSING.md.
If docs/ exists, no action needed.

Check if docs/ is gitignored and handle appropriately.
  </action>
  <verify>Run: ls -la docs/</verify>
  <done>docs directory exists with DATA-PROCESSING.md</done>
</task>

</tasks>

<verification>
1. Documentation file exists with 200+ lines
2. All sections are populated with accurate information
3. Metadata schema matches pinecone.ts ChunkMetadata type
4. R2 folder structure matches actual storage patterns
</verification>

<success_criteria>
- Chunking strategy documented per source type
- Metadata schema fully documented
- R2 folder structure documented with examples
- Embedding configuration documented
- Quality metrics explained
</success_criteria>

<output>
After completion, create `.planning/phases/06-data-processing/06-07-SUMMARY.md`
</output>
