---
phase: 06-data-processing
plan: 06
type: execute
wave: 3
depends_on: ["06-04", "06-05"]
files_modified:
  - apps/workers/src/index.ts
  - scripts/validate-pipeline.ts
autonomous: true

must_haves:
  truths:
    - "User can GET /validation/coverage and see which jurisdictions are indexed vs missing"
    - "User can GET /validation/quality and see token distribution, metadata completeness per source type"
    - "User can run validate-pipeline.ts locally and see a full validation report in terminal"
    - "User can request markdown or JSON format and receive properly formatted output"
  artifacts:
    - path: "apps/workers/src/index.ts"
      provides: "HTTP endpoint for validation"
      contains: "GET /validation"
    - path: "scripts/validate-pipeline.ts"
      provides: "CLI script for local validation"
      min_lines: 80
  key_links:
    - from: "apps/workers/src/index.ts"
      to: "apps/workers/src/validation/index.ts"
      via: "validation module import"
      pattern: "import.*from.*validation"
    - from: "scripts/validate-pipeline.ts"
      to: "apps/workers/src/validation/index.ts"
      via: "validation module usage"
      pattern: "import.*validation"
---

<objective>
Add HTTP endpoint and CLI script for running pipeline validation.

Purpose: Provide interfaces to trigger validation - an HTTP endpoint for production use and a CLI script for local testing. This completes the Phase 6 validation suite.

Output: GET /validation endpoint in Workers and scripts/validate-pipeline.ts for CLI use.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-data-processing/06-04-PLAN.md
@.planning/phases/06-data-processing/06-05-PLAN.md
@apps/workers/src/index.ts
@scripts/test-municipal-query.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add HTTP validation endpoint</name>
  <files>apps/workers/src/index.ts</files>
  <action>
Add validation endpoints to the Workers entry point:

1. **Import validation module:**
   ```typescript
   import {
     checkCoverage,
     generateFullValidationReport,
     formatValidationResultMarkdown,
   } from './validation';
   ```

2. **Add GET /validation/coverage endpoint:**
   - Initialize Pinecone with env.PINECONE_API_KEY
   - Get index
   - Call checkCoverage(index)
   - Return JSON response with coverage report

3. **Add GET /validation/quality endpoint:**
   - Initialize Pinecone
   - Call generateFullValidationReport(index)
   - Return JSON response with validation result

4. **Add GET /validation/report endpoint:**
   - Initialize Pinecone
   - Call generateFullValidationReport(index)
   - Call formatValidationResultMarkdown(result)
   - Return text/markdown response

5. **Add GET /validation/summary endpoint:**
   - Quick summary combining coverage + quality
   - Return JSON with: coveragePercent, totalChunks, avgTokens, issuesCount, timestamp

Add error handling for missing PINECONE_API_KEY.
Add timing logging for validation duration.
  </action>
  <verify>Run: cd apps/workers && pnpm exec tsc --noEmit</verify>
  <done>Validation endpoints added and compile successfully</done>
</task>

<task type="auto">
  <name>Task 2: Create CLI validation script</name>
  <files>scripts/validate-pipeline.ts</files>
  <action>
Create CLI script for local validation testing:

```typescript
/**
 * Pipeline Validation Script
 *
 * Runs full validation suite against Pinecone index and outputs reports.
 *
 * Usage:
 *   pnpm exec tsx scripts/validate-pipeline.ts
 *   pnpm exec tsx scripts/validate-pipeline.ts --format=markdown
 *   pnpm exec tsx scripts/validate-pipeline.ts --coverage-only
 *
 * Environment:
 *   PINECONE_API_KEY - Required
 */
```

1. **Parse command line args:**
   - --format=json|markdown (default: json)
   - --coverage-only (skip quality report)
   - --output=filename (optional file output)

2. **Load environment:**
   - Use dotenv to load .env file
   - Require PINECONE_API_KEY

3. **Initialize Pinecone:**
   - Import from @pinecone-database/pinecone
   - Initialize client with API key
   - Get compliance-embeddings index

4. **Run validation:**
   - If --coverage-only: run checkCoverage
   - Otherwise: run generateFullValidationReport

5. **Output results:**
   - JSON format: JSON.stringify with pretty print
   - Markdown format: use formatValidationResultMarkdown
   - Write to file if --output specified, else console.log

6. **Summary logging:**
   - Log start time
   - Log validation duration
   - Log summary stats (coverage %, chunk count, issues)

Follow patterns from test-municipal-query.ts for script structure.
Use process.exit(1) on errors.
  </action>
  <verify>Run: pnpm exec tsx scripts/validate-pipeline.ts --help 2>&1 | head -5 || echo "Script created"</verify>
  <done>Validation script runs and shows usage or executes validation</done>
</task>

</tasks>

<verification>
1. HTTP endpoints respond with correct content types
2. CLI script runs without errors (assuming PINECONE_API_KEY set)
3. Both JSON and markdown formats work
4. Error handling for missing API keys
</verification>

<success_criteria>
- GET /validation/coverage returns JSON coverage report
- GET /validation/quality returns JSON validation result
- GET /validation/report returns markdown report
- CLI script runs with format and output options
- Both interfaces use the same validation module
</success_criteria>

<output>
After completion, create `.planning/phases/06-data-processing/06-06-SUMMARY.md`
</output>
