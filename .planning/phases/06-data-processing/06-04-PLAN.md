---
phase: 06-data-processing
plan: 04
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - apps/workers/src/validation/coverage-checker.ts
autonomous: true

must_haves:
  truths:
    - "Coverage checker queries Pinecone for indexed jurisdictions"
    - "Checker compares indexed sources against target lists"
    - "Gaps are identified with jurisdiction and reason"
  artifacts:
    - path: "apps/workers/src/validation/coverage-checker.ts"
      provides: "Coverage validation against target lists"
      exports: ["checkCoverage", "getCoverageBySourceType", "identifyGaps"]
  key_links:
    - from: "apps/workers/src/validation/coverage-checker.ts"
      to: "apps/workers/src/pinecone.ts"
      via: "Pinecone index access"
      pattern: "import.*getIndex.*from.*pinecone"
    - from: "apps/workers/src/validation/coverage-checker.ts"
      to: "apps/workers/src/federal/types.ts"
      via: "TARGET_TITLES import"
      pattern: "TARGET_TITLES"
---

<objective>
Build coverage checker to compare indexed data against target jurisdiction lists.

Purpose: Validate that all target jurisdictions (federal titles, Texas statutes, counties, cities) have been processed and indexed. This validates DATA requirements by ensuring expected coverage is achieved.

Output: Functions to query Pinecone coverage, compare against targets, and identify gaps.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-data-processing/06-01-PLAN.md
@apps/workers/src/pinecone.ts
@apps/workers/src/federal/types.ts
@apps/workers/src/counties/sources.ts
@apps/workers/src/municipal/cities.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create coverage checker</name>
  <files>apps/workers/src/validation/coverage-checker.ts</files>
  <action>
Create coverage checking utilities:

1. **Target list imports:**
   - Import TARGET_TITLES from federal/types.ts (array of {number, name})
   - Import getEnabledCounties from counties/sources.ts
   - Import getEnabledCities from municipal/cities.ts
   - These define what SHOULD be indexed

2. **getIndexedJurisdictions(index: Index, sourceType: string): Promise<string[]>**
   - Query Pinecone for distinct jurisdictions for given sourceType
   - Use a dummy query vector with topK=10000 and filter by sourceType
   - Extract unique jurisdiction values from results
   - Note: Pinecone doesn't have distinct(), so we query and dedupe

3. **checkFederalCoverage(index: Index): Promise<JurisdictionCoverage[]>**
   - Get indexed jurisdictions for sourceType='federal'
   - Compare against TARGET_TITLES
   - Return coverage status per title

4. **checkCountyCoverage(index: Index): Promise<JurisdictionCoverage[]>**
   - Get indexed jurisdictions for sourceType='county'
   - Compare against getEnabledCounties()
   - Match by jurisdiction format 'TX-{fipsCode}'

5. **checkMunicipalCoverage(index: Index): Promise<JurisdictionCoverage[]>**
   - Get indexed jurisdictions for sourceType='municipal'
   - Compare against getEnabledCities()
   - Match by jurisdiction format 'TX-{cityId}'

6. **checkCoverage(index: Index): Promise<CoverageReport>**
   - Call all check*Coverage functions
   - Aggregate into CoverageReport from types.ts
   - Calculate totals and percentages

7. **identifyGaps(coverageReport: CoverageReport): Gap[]**
   - Gap: { jurisdiction: string, sourceType: string, reason: string }
   - Extract jurisdictions where indexed=false
   - Return array of gaps for reporting

Note: State coverage (Texas statutes/TAC) uses jurisdiction='TX' and sourceType='state'.
For state, we can count vectors but not easily determine which codes are missing.

Import types from './types' (CoverageReport, JurisdictionCoverage).
Add JSDoc explaining query approach and limitations.
  </action>
  <verify>Run: cd apps/workers && pnpm exec tsc --noEmit src/validation/coverage-checker.ts</verify>
  <done>Coverage checker compiles with all functions exported</done>
</task>

<task type="auto">
  <name>Task 2: Update module exports</name>
  <files>apps/workers/src/validation/index.ts</files>
  <action>
Update module index to export coverage checker:

```typescript
/**
 * Data Processing Validation Module
 *
 * Provides types and utilities for validating the end-to-end
 * data processing pipeline across all jurisdiction types.
 *
 * @module validation
 */

export * from './types';
export * from './token-analyzer';
export * from './metadata-validator';
export * from './coverage-checker';
```
  </action>
  <verify>Run: cd apps/workers && pnpm exec tsc --noEmit src/validation/index.ts</verify>
  <done>Coverage checker exports accessible from validation module</done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes
2. All target list imports resolve correctly
3. Coverage report types match types.ts definitions
4. Gap identification correctly filters missing jurisdictions
</verification>

<success_criteria>
- checkCoverage returns complete CoverageReport
- Federal coverage compared against TARGET_TITLES
- County coverage compared against enabled counties
- Municipal coverage compared against enabled cities
- Gaps correctly identified with reasons
</success_criteria>

<output>
After completion, create `.planning/phases/06-data-processing/06-04-SUMMARY.md`
</output>
