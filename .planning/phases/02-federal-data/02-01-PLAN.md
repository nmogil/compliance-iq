---
phase: 02-federal-data
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/workers/src/federal/types.ts
  - apps/workers/src/lib/tokens.ts
  - apps/workers/src/lib/citations.ts
  - apps/workers/package.json
autonomous: true

must_haves:
  truths:
    - "Token counting produces accurate counts for CFR text"
    - "Bluebook citations generated from CFR metadata match legal format"
    - "TypeScript types enforce CFR data structure"
  artifacts:
    - path: "apps/workers/src/federal/types.ts"
      provides: "CFR data types and interfaces"
      exports: ["CFRTitle", "CFRPart", "CFRSection", "CFRChunk", "PipelineCheckpoint"]
    - path: "apps/workers/src/lib/tokens.ts"
      provides: "Token counting utilities"
      exports: ["countTokens", "validateChunkSize"]
    - path: "apps/workers/src/lib/citations.ts"
      provides: "Bluebook citation generation"
      exports: ["generateCFRCitation", "generateECFRUrl"]
  key_links:
    - from: "apps/workers/src/federal/types.ts"
      to: "apps/workers/src/pinecone.ts"
      via: "ChunkMetadata compatibility"
      pattern: "sourceType.*federal"
---

<objective>
Create foundational types and utility modules for the federal data pipeline.

Purpose: Establish type-safe data structures and reusable utilities (token counting, citation formatting) before building the pipeline components. These types and utilities will be used by all subsequent plans in this phase.

Output:
- TypeScript interfaces for CFR data structures (titles, parts, sections, chunks)
- Token counting utility using js-tiktoken (cl100k_base encoding)
- Bluebook citation generator for CFR references
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-federal-data/02-CONTEXT.md
@.planning/phases/02-federal-data/02-RESEARCH.md
@apps/workers/src/pinecone.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create federal types</name>
  <files>
    apps/workers/package.json
    apps/workers/src/federal/types.ts
  </files>
  <action>
1. Install required dependencies in apps/workers:
   ```bash
   pnpm add --filter @compliance-iq/workers js-tiktoken fast-xml-parser date-fns zod
   ```

2. Create `apps/workers/src/federal/types.ts` with TypeScript interfaces:

   - `CFRTitle`: Represents a CFR title (number, name, chapters)
   - `CFRPart`: Represents a part within a title (number, name, sections)
   - `CFRSection`: Represents a section (number, text, subsections, metadata)
   - `CFRChunk`: Processed chunk ready for embedding, compatible with ChunkMetadata:
     - chunkId: string
     - sourceId: string (e.g., "cfr-title-21")
     - text: string
     - citation: string (Bluebook format)
     - url: string (eCFR.gov link)
     - title: number
     - part: number
     - section: string
     - subsection?: string
     - hierarchy: string[] (breadcrumbs)
     - category?: string (activity tag)
     - effectiveDate?: string
     - lastAmended?: string
   - `PipelineCheckpoint`: For R2 checkpointing (titleNumber, lastProcessedPart, timestamp)
   - `CFRTitleConfig`: Configuration for which titles to process (number, name, categories[])

3. Include the 7 target CFR titles as a constant:
   - Title 7: Agriculture (categories: ['food-retail', 'food-safety'])
   - Title 9: Animals & Animal Products (categories: ['food-safety'])
   - Title 21: Food & Drugs (categories: ['food-safety', 'pharmacy'])
   - Title 27: Alcohol, Tobacco, Firearms (categories: ['alcohol'])
   - Title 29: Labor (categories: ['employment'])
   - Title 40: Environment (categories: ['fuel', 'hazmat'])
   - Title 49: Transportation (categories: ['fuel', 'transportation'])
  </action>
  <verify>
    - pnpm install completes without errors
    - `pnpm --filter @compliance-iq/workers exec tsc --noEmit` passes
    - types.ts exports all interfaces
  </verify>
  <done>
    - Dependencies installed: js-tiktoken, fast-xml-parser, date-fns, zod
    - TypeScript interfaces defined for CFR data structures
    - TARGET_TITLES constant lists all 7 federal titles with categories
  </done>
</task>

<task type="auto">
  <name>Task 2: Create token counting utility</name>
  <files>apps/workers/src/lib/tokens.ts</files>
  <action>
Create `apps/workers/src/lib/tokens.ts` with token counting functions using js-tiktoken:

1. `countTokens(text: string): number`
   - Use cl100k_base encoding (for text-embedding-3-large)
   - Return accurate token count
   - Free encoder after use to prevent memory leaks

2. `validateChunkSize(text: string, maxTokens: number = 1500): { valid: boolean; tokens: number }`
   - Count tokens and compare to max (default 1500, well under 8192 limit)
   - Return object with validity and actual count

3. `estimateChunkCount(text: string, targetTokens: number = 1500): number`
   - Estimate how many chunks text will split into
   - Used for progress estimation

Note: Use `encoding_for_model('text-embedding-3-large')` from js-tiktoken. The encoder must be freed after each use to avoid memory leaks in Workers environment.
  </action>
  <verify>
    - pnpm --filter @compliance-iq/workers exec tsc --noEmit passes
    - Module exports countTokens, validateChunkSize, estimateChunkCount
  </verify>
  <done>
    - Token counting uses cl100k_base encoding
    - Validates against 1500 token target (headroom under 8192)
    - Encoder properly freed after each operation
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Bluebook citation generator</name>
  <files>apps/workers/src/lib/citations.ts</files>
  <action>
Create `apps/workers/src/lib/citations.ts` with citation utilities:

1. `generateCFRCitation(title: number, section: string, subsection?: string): string`
   - Format: "[Title] C.F.R. ยง [Section][(Subsection)]"
   - Examples:
     - generateCFRCitation(21, '117.3') => "21 C.F.R. ยง 117.3"
     - generateCFRCitation(21, '117.3', '(a)(1)') => "21 C.F.R. ยง 117.3(a)(1)"
   - Validate that section format is correct (numeric.numeric)

2. `generateECFRUrl(title: number, part: number, section: string): string`
   - Format: "https://www.ecfr.gov/current/title-{title}/part-{part}/section-{section}"
   - Example: generateECFRUrl(21, 117, '117.3') => "https://www.ecfr.gov/current/title-21/part-117/section-117.3"

3. `generateHierarchy(title: number, chapter: string, part: number, section: string): string[]`
   - Return breadcrumb array: ["Title 21", "Chapter I", "Part 117", "Section 117.3"]
   - Used for context in RAG retrieval

4. `parseSection(sectionString: string): { part: number; section: string }`
   - Parse "117.3" into { part: 117, section: "117.3" }
   - Handle edge cases: "1.1", "999.999"
  </action>
  <verify>
    - pnpm --filter @compliance-iq/workers exec tsc --noEmit passes
    - generateCFRCitation(21, '117.3') returns "21 C.F.R. ยง 117.3"
    - generateECFRUrl(21, 117, '117.3') returns correct URL
  </verify>
  <done>
    - Bluebook citations in standard legal format
    - eCFR URLs link directly to specific sections
    - Hierarchy breadcrumbs support RAG context
  </done>
</task>

</tasks>

<verification>
1. All dependencies installed: `pnpm --filter @compliance-iq/workers list`
2. TypeScript compiles: `pnpm --filter @compliance-iq/workers exec tsc --noEmit`
3. All exports available from new modules
4. Types compatible with existing ChunkMetadata in pinecone.ts
</verification>

<success_criteria>
- Dependencies (js-tiktoken, fast-xml-parser, date-fns, zod) installed
- CFR types defined with full metadata support
- Token counting accurate for text-embedding-3-large model
- Bluebook citations match standard legal format
- eCFR URLs link to official source
</success_criteria>

<output>
After completion, create `.planning/phases/02-federal-data/02-01-SUMMARY.md`
</output>
