---
phase: 02-federal-data
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/workers/src/federal/fetch.ts
  - apps/workers/src/types.ts
autonomous: true

must_haves:
  truths:
    - "eCFR API returns XML content for any CFR title"
    - "Fetcher handles rate limits and retries gracefully"
    - "XML structure parsed into navigable parts and sections"
  artifacts:
    - path: "apps/workers/src/federal/fetch.ts"
      provides: "eCFR API integration"
      exports: ["fetchCFRTitle", "fetchCFRTitleList", "parseCFRXML"]
    - path: "apps/workers/src/types.ts"
      provides: "Updated Env with API keys"
      contains: "OPENAI_API_KEY"
  key_links:
    - from: "apps/workers/src/federal/fetch.ts"
      to: "https://www.ecfr.gov/api"
      via: "HTTP fetch"
      pattern: "ecfr.gov/api"
---

<objective>
Build eCFR API integration to fetch federal regulation XML data.

Purpose: Create the data fetcher that retrieves CFR titles from the eCFR API. This is the entry point for the federal data pipeline - raw XML is fetched here before being stored, chunked, and embedded.

Output:
- eCFR API fetcher module
- XML parser for CFR structure
- Updated Env types with required API keys
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-federal-data/02-CONTEXT.md
@.planning/phases/02-federal-data/02-RESEARCH.md
@apps/workers/src/types.ts
@apps/workers/wrangler.jsonc
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Env types with required secrets</name>
  <files>
    apps/workers/src/types.ts
    apps/workers/wrangler.jsonc
  </files>
  <action>
1. Update `apps/workers/src/types.ts` to add environment variables:

```typescript
export interface Env {
  // R2 bucket for storing compliance documents
  DOCUMENTS_BUCKET: R2Bucket;

  // API keys (secrets, not in wrangler.jsonc)
  OPENAI_API_KEY: string;
  PINECONE_API_KEY: string;

  // Convex URL for syncing freshness data
  CONVEX_URL: string;
}
```

2. Document in wrangler.jsonc that secrets must be set via wrangler:
   - Add a comment block explaining: OPENAI_API_KEY, PINECONE_API_KEY, CONVEX_URL are secrets
   - These are set via `wrangler secret put OPENAI_API_KEY` etc.
   - Do NOT add actual values to wrangler.jsonc

Note: Secrets are configured at deploy time, not in source control.
  </action>
  <verify>
    - pnpm --filter @compliance-iq/workers exec tsc --noEmit passes
    - Env interface includes all required keys
  </verify>
  <done>
    - Env type updated with OPENAI_API_KEY, PINECONE_API_KEY, CONVEX_URL
    - Documentation added for secret configuration
  </done>
</task>

<task type="auto">
  <name>Task 2: Create eCFR API fetcher module</name>
  <files>apps/workers/src/federal/fetch.ts</files>
  <action>
Create `apps/workers/src/federal/fetch.ts` with eCFR API integration:

1. `fetchCFRTitleList(): Promise<{ number: number; name: string }[]>`
   - Fetch list of all CFR titles from eCFR API
   - Endpoint: GET https://www.ecfr.gov/api/versioner/v1/titles
   - Return array of title numbers and names

2. `fetchCFRTitle(titleNumber: number): Promise<string>`
   - Fetch full XML for a specific CFR title
   - Endpoint: GET https://www.ecfr.gov/api/versioner/v1/full/{date}/title-{titleNumber}.xml
   - Use current date for {date} in YYYY-MM-DD format
   - Return raw XML string
   - Handle errors: 404 (title not found), 429 (rate limit), 5xx (server error)
   - Implement retry with exponential backoff (3 retries, 1s/2s/4s delays)

3. `fetchCFRPart(titleNumber: number, partNumber: number): Promise<string>`
   - Fetch XML for a specific part within a title
   - Endpoint: GET https://www.ecfr.gov/api/versioner/v1/full/{date}/title-{titleNumber}.xml?part={partNumber}
   - Return raw XML string

4. Error handling:
   - Create custom error class `ECFRFetchError` with status, title, message
   - Log fetch attempts for debugging
   - Return meaningful error messages

Note: The eCFR API may have rate limits. Start conservatively with 1 request/second. If rate limited, back off exponentially.
  </action>
  <verify>
    - pnpm --filter @compliance-iq/workers exec tsc --noEmit passes
    - Module exports fetchCFRTitle, fetchCFRTitleList, fetchCFRPart
    - Error handling implemented with retry logic
  </verify>
  <done>
    - eCFR API fetcher with retry logic
    - Fetches full titles or specific parts
    - Handles rate limits gracefully
  </done>
</task>

<task type="auto">
  <name>Task 3: Create XML parser for CFR structure</name>
  <files>apps/workers/src/federal/fetch.ts</files>
  <action>
Add XML parsing functions to `apps/workers/src/federal/fetch.ts`:

1. Install and use fast-xml-parser (already added in 02-01):

2. `parseCFRXML(xml: string): CFRTitle`
   - Parse XML into CFRTitle structure
   - Extract title metadata (number, name, effective date)
   - Navigate DIV hierarchy: DIV1 (title) > DIV3 (chapter) > DIV5 (subchapter) > DIV6 (part) > DIV8 (section)
   - Handle variations in XML structure (some titles omit subchapters)

3. `extractParts(titleXML: string): CFRPart[]`
   - Extract all parts from a title XML
   - For each part: number, name, sections[]
   - Preserve section numbering (e.g., "117.1", "117.3")

4. `extractSections(partXML: string): CFRSection[]`
   - Extract all sections from a part
   - For each section: number, heading, text content, subsections
   - Preserve subsection structure (a), (b), (c)...
   - Capture effective date and last amended date from XML attributes

XML parsing notes:
- Use fast-xml-parser with options: { ignoreAttributes: false, attributeNamePrefix: '@_' }
- CFR XML uses DIV elements with TYPE attributes (e.g., TYPE="TITLE", TYPE="PART", TYPE="SECTION")
- Section text is in <P> and <FP> elements
- Preserve formatting for legal accuracy
  </action>
  <verify>
    - pnpm --filter @compliance-iq/workers exec tsc --noEmit passes
    - parseCFRXML successfully parses sample CFR XML
    - Parts and sections extracted with correct structure
  </verify>
  <done>
    - XML parser handles CFR DIV hierarchy
    - Parts and sections extracted with metadata
    - Subsection structure preserved
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `pnpm --filter @compliance-iq/workers exec tsc --noEmit`
2. Env types include all required secrets
3. Fetch module exports all required functions
4. XML parser handles CFR structure correctly
</verification>

<success_criteria>
- eCFR API integration fetches title XML
- XML parser extracts parts and sections
- Error handling with retry logic
- Env types updated for secrets
</success_criteria>

<output>
After completion, create `.planning/phases/02-federal-data/02-02-SUMMARY.md`
</output>
