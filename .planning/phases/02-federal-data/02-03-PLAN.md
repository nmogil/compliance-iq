---
phase: 02-federal-data
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - apps/workers/src/lib/r2.ts
  - apps/workers/src/federal/storage.ts
autonomous: true

must_haves:
  truths:
    - "Raw CFR XML persists in R2 with audit metadata"
    - "Pipeline checkpoints enable resume after failure"
    - "R2 storage organized by jurisdiction/title/part hierarchy"
  artifacts:
    - path: "apps/workers/src/lib/r2.ts"
      provides: "R2 storage utilities"
      exports: ["storeDocument", "getDocument", "listDocuments"]
    - path: "apps/workers/src/federal/storage.ts"
      provides: "Federal-specific R2 operations"
      exports: ["storeCFRPart", "getCFRPart", "saveCheckpoint", "loadCheckpoint"]
  key_links:
    - from: "apps/workers/src/federal/storage.ts"
      to: "apps/workers/src/types.ts"
      via: "Env.DOCUMENTS_BUCKET"
      pattern: "DOCUMENTS_BUCKET"
---

<objective>
Create R2 storage pipeline for raw CFR data and pipeline checkpointing.

Purpose: Store raw CFR XML in R2 for audit trail and reprocessing. Implement checkpointing so the pipeline can resume from failures without re-fetching already processed data.

Output:
- R2 storage utilities for document persistence
- Federal-specific storage with organized folder structure
- Checkpoint management for pipeline resilience
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-federal-data/02-CONTEXT.md
@.planning/phases/02-federal-data/02-RESEARCH.md
@.planning/phases/02-federal-data/02-01-SUMMARY.md
@apps/workers/src/types.ts
@apps/workers/src/federal/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create R2 storage utilities</name>
  <files>apps/workers/src/lib/r2.ts</files>
  <action>
Create `apps/workers/src/lib/r2.ts` with generic R2 storage functions:

1. `storeDocument(bucket: R2Bucket, key: string, content: string | ArrayBuffer, metadata: DocumentMetadata): Promise<void>`
   - Store document with custom metadata
   - Set content type based on extension (.xml, .json, .txt)
   - Add standard metadata: storedAt timestamp, contentLength

2. `getDocument(bucket: R2Bucket, key: string): Promise<{ content: string; metadata: Record<string, string> } | null>`
   - Retrieve document and its metadata
   - Return null if not found
   - Parse custom metadata from R2 object

3. `listDocuments(bucket: R2Bucket, prefix: string, limit?: number): Promise<R2DocumentInfo[]>`
   - List documents under a prefix (folder structure)
   - Return array with key, size, uploaded timestamp
   - Support pagination via cursor

4. `deleteDocument(bucket: R2Bucket, key: string): Promise<boolean>`
   - Delete a document
   - Return true if deleted, false if not found

5. Types:
   ```typescript
   interface DocumentMetadata {
     source: string;           // e.g., 'eCFR'
     dataType: string;         // e.g., 'raw-regulation', 'checkpoint'
     fetchedAt: string;        // ISO timestamp
     [key: string]: string;    // Additional metadata
   }

   interface R2DocumentInfo {
     key: string;
     size: number;
     uploaded: Date;
     metadata?: Record<string, string>;
   }
   ```

Note: R2 customMetadata values must be strings. Convert numbers/dates to strings.
  </action>
  <verify>
    - pnpm --filter @compliance-iq/workers exec tsc --noEmit passes
    - Module exports storeDocument, getDocument, listDocuments, deleteDocument
    - Types properly defined
  </verify>
  <done>
    - Generic R2 utilities for document storage
    - Metadata support for audit trail
    - List/delete operations for management
  </done>
</task>

<task type="auto">
  <name>Task 2: Create federal-specific storage module</name>
  <files>apps/workers/src/federal/storage.ts</files>
  <action>
Create `apps/workers/src/federal/storage.ts` for CFR-specific storage:

1. R2 folder structure:
   ```
   federal/
   ├── cfr/
   │   ├── title-7/
   │   │   ├── part-1.xml
   │   │   ├── part-2.xml
   │   │   └── ...
   │   ├── title-21/
   │   │   └── ...
   │   └── ...
   └── checkpoints/
       ├── cfr-title-7.json
       ├── cfr-title-21.json
       └── ...
   ```

2. `storeCFRPart(bucket: R2Bucket, titleNumber: number, partNumber: number, xml: string): Promise<void>`
   - Key: `federal/cfr/title-${titleNumber}/part-${partNumber}.xml`
   - Metadata:
     - source: 'eCFR'
     - dataType: 'raw-regulation'
     - titleNumber: string
     - partNumber: string
     - fetchedAt: ISO timestamp

3. `getCFRPart(bucket: R2Bucket, titleNumber: number, partNumber: number): Promise<string | null>`
   - Retrieve stored part XML
   - Return null if not found

4. `listCFRParts(bucket: R2Bucket, titleNumber: number): Promise<number[]>`
   - List all stored part numbers for a title
   - Parse part numbers from keys

5. `saveCheckpoint(bucket: R2Bucket, titleNumber: number, checkpoint: PipelineCheckpoint): Promise<void>`
   - Key: `federal/checkpoints/cfr-title-${titleNumber}.json`
   - Store checkpoint as JSON

6. `loadCheckpoint(bucket: R2Bucket, titleNumber: number): Promise<PipelineCheckpoint | null>`
   - Load checkpoint if exists
   - Return null if no checkpoint (fresh start)

7. `clearCheckpoint(bucket: R2Bucket, titleNumber: number): Promise<void>`
   - Delete checkpoint after successful completion
   - Allows fresh run next time

Import PipelineCheckpoint from './types.ts' (created in 02-01).
  </action>
  <verify>
    - pnpm --filter @compliance-iq/workers exec tsc --noEmit passes
    - Module exports all storage functions
    - Folder structure follows specification
  </verify>
  <done>
    - CFR XML stored in organized folder structure
    - Checkpointing enables pipeline resume
    - Metadata captures audit information
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `pnpm --filter @compliance-iq/workers exec tsc --noEmit`
2. R2 utilities export all required functions
3. Federal storage uses correct key patterns
4. Checkpoint types match PipelineCheckpoint from types.ts
</verification>

<success_criteria>
- Raw CFR XML storable in R2 with audit metadata
- Organized folder structure (federal/cfr/title-X/part-Y.xml)
- Checkpoint save/load enables pipeline resilience
- All metadata captured for reprocessing
</success_criteria>

<output>
After completion, create `.planning/phases/02-federal-data/02-03-SUMMARY.md`
</output>
